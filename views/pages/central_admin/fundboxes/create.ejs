<div class="container-fluid" id="createFundboxesContainer">
	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.add_suppliers.sectionTitle %></h1>
	</div>
	<div class="mt-3 app-block" id="wrapper01">
		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>
		<form action="#" id="create_form">
			<div class="row gx-4 gy-4">

				<div class="col-lg-12 col-md-12 col-sm-12">
					<div class="">
						<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label_name_ar %></label>
						<input type="text" class="input-text input-text-outline" id="name_ar_input">
					</div>	
				</div>

				<div class="col-lg-12 col-md-12 col-sm-12">
					<div class="">
						<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label_name_fr %></label>
						<input type="text" class="input-text input-text-outline" id="name_fr_input">
					</div>	
				</div>
                
				<div class="col-lg-12 col-md-12 col-sm-12">
					<div class="">
						<%- include(SETTINGS.UI_Settings.MAIN_DIR_NAME+'views/templates/select-fundbox-owner-type.template.ejs', {
                            id: 'owner_type_select',
                            targets: {
                                target1: '#centers_tab',
                                target2: '#distributors_tab',
                                target3: '#employees_tab',
                                target4: '#central_administration_tab',
                            }
                        }) -%>
						<div class="py-3 px-2 border rounded mt-2">

                            <div id="centers_tab">
                                <%- include(SETTINGS.UI_Settings.MAIN_DIR_NAME+'views/templates/select-centers.template.ejs', {eventsReceiverId: 'createFundboxesContainer'}) -%>
                            </div>

                            <div id="distributors_tab" style="display:none;">
                                <%- include(SETTINGS.UI_Settings.MAIN_DIR_NAME+'views/templates/select-distributors.template.ejs', {
                                    eventsReceiverId: 'createFundboxesContainer',
                                    options: {
                                        search: {
                                            currentAdministrationOnly: false
                                        }
                                    }
                                }) 
                                -%>
                            </div>

                            <div id="employees_tab" style="display:none;">
                                <%- include(SETTINGS.UI_Settings.MAIN_DIR_NAME+'views/templates/select-employees.template.ejs', {eventsReceiverId: 'createFundboxesContainer'}) -%>
                            </div>

                            <div id="central_administration_tab" style="display:none;">
                                
                            </div>

                        </div>
					</div>	
				</div>

			</div>

			<div class="mt-3">
				<input type="submit" class="btn btn-primary btn-sm shadow" value="<%= UI_DISPLAY_LANG.views.pages.global.save_changes_button %>">
			</div>

		</form>
	</div>
</div>

<script>

$(function()
{

var page_container = $('#createFundboxesContainer');
if ( page_container[0] == undefined )
    return;

var ERROR_BOX = page_container.find('#ERROR_BOX');

var create_form = page_container.find('#create_form')
var name_ar_input = create_form.find('#name_ar_input')
var name_fr_input = create_form.find('#name_fr_input')
var owner_type_select = create_form.find('#owner_type_select')
var select_centers_template_center_select = create_form.find('#select_centers_template_center_select')
var select_distributors_template_distributor_select = create_form.find('#select_distributors_template_distributor_select')
var select_employees_template_employee_select = create_form.find('#select_employees_template_employee_select')

var FundBoxObject = {
    id: sessionData(true).id
}
// select owner type
owner_type_select.on('change', e =>
{
    var selected = owner_type_select.find(':selected')

    var tab = page_container.find(selected.data('target'))

    tab.slideDown(200).siblings().slideUp(200)

    if ( tab.attr('id') == 'central_administration_tab' )
        tab.parent().addClass('d-none')
    else
        tab.parent().removeClass('d-none')
})
// submit
create_form.on('submit', async e =>
{
    e.preventDefault()

    var target = create_form
    var owner_type = owner_type_select.find(':selected').val()

    if ( owner_type == 'centers' )
    {
        FundBoxObject.owner_id = select_centers_template_center_select.find(':selected').val()
        FundBoxObject.owner_name = select_centers_template_center_select.find(':selected').text()
    }
    else if ( owner_type == 'distributors' )
    {
        FundBoxObject.owner_id = select_distributors_template_distributor_select.find(':selected').val()
        FundBoxObject.owner_name = select_distributors_template_distributor_select.find(':selected').text()
    }
    else if ( owner_type == 'employees' )
    {
        FundBoxObject.owner_id = select_employees_template_employee_select.find(':selected').val()
        FundBoxObject.owner_name = select_employees_template_employee_select.find(':selected').text()
    }
    else if ( owner_type == 'central_administration' )
    {
        FundBoxObject.owner_id = null
        FundBoxObject.owner_name = null
    }

    FundBoxObject.name_ar = name_ar_input.val()
    FundBoxObject.name_fr = name_fr_input.val()
    FundBoxObject.owner_type = owner_type

    SectionLoader(target)
    // update
    if ( FundBoxObject.id )
    {
        var res = await FUNDBOX_MODEL.update(FundBoxObject)
        // hide loader
        SectionLoader(target, '')
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
        if ( res.code == 404 ) return
        //
        target[0].reset();
        FundBoxObject.id = null;

        return
    }

    // store
    var res = await FUNDBOX_MODEL.store(FundBoxObject)
    // hide loader
    SectionLoader(target, '')
    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
    if ( res.code == 404 ) return
    //
    target[0].reset();
})
// display one
displayOne();
async function displayOne()
{
    if ( FundBoxObject.id == null )
        return;

    // display loader
    SectionLoader(create_form);
    var response = await FUNDBOX_MODEL.show({
		id: FundBoxObject.id
	})
    // hide loader
    SectionLoader(create_form, '');
    if ( response.code == 404 )
        return;

    var data = response.data;
    
    name_ar_input.val(data.name_ar)
    name_fr_input.val(data.name_fr)
    FundBoxObject.owner_id = data.owner_id
    FundBoxObject.owner_name = data.owner_name
    setOptionSelected(owner_type_select, data.owner_type, true)
    if ( data.owner_type == 'centers' )
    {
        $(document).off('center-selected').on('center-selected', e =>
        {
            var detail = e.originalEvent.detail
            if ( detail.eventsReceiverId != page_container.attr('id') ) return
            console.log(detail)
            setOptionSelected(select_centers_template_center_select, detail.center.id)
        })
    }
    else if ( data.owner_type == 'distributors' )
    {
        $(document).off('distributor-selected').on('center-selected', e =>
        {
            var detail = e.originalEvent.detail
            if ( detail.eventsReceiverId != page_container.attr('id') ) return
            console.log(detail)
            setOptionSelected(select_distributors_template_distributor_select, detail.distributor.id)
        })
    }
    else if ( data.owner_type == 'employees' )
    {
        $(document).off('employee-selected').on('center-selected', e =>
        {
            var detail = e.originalEvent.detail
            if ( detail.eventsReceiverId != page_container.attr('id') ) return
            console.log(detail)
            setOptionSelected(select_employees_template_employee_select, detail.employee.id)
        })
    }
}

})

</script>