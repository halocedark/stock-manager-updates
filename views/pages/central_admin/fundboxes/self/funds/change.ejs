<div class="container-fluid" id="add_funds_to_fundboxes_container">

    <div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.add_clinics.sectionTitle %></h1>
	</div>
    
	<div class="mt-3">

		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>

        <form id="create_form">

            <div class="row gx-4">

                <div class="col-lg-6 col-md-6">

                    <div class="mb-4 pt-5">
                        <h3 class="h3"><%= UI_DISPLAY_LANG.views.pages.global.text16 %></h3>
                        <p class="text-muted"><%= UI_DISPLAY_LANG.views.pages.global.text17 %></p>
                    </div>

                    <div class="fs-20">
                        <span class="fw-700"><%= UI_DISPLAY_LANG.views.pages.global.text22 %>:</span> <span class="text-success" id="owner_total">0.00</span>
                    </div>

                    <div class="mb-2">
                        <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label30 %></label>
                        <select name="" class="input-text" id="operation_select">
                            <option value="add"><%= UI_DISPLAY_LANG.views.pages.global.actions.add %></option>
                            <option value="subtract"><%= UI_DISPLAY_LANG.views.pages.global.actions.subtract %></option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label49 %></label>
                        <input type="number" step="any" min="0" class="input-text input-text-outline input-success" id="amount_input" value="0.00">
                        <div class="mt-2 px-3">
                            <span class="fw-500 text-success" id="amount_label">+(0.00)</span>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label48 %></label>
                        <input type="text" class="input-text input-text-outline" id="reason_input">
                    </div>

                    <div class="mb-4">
                        <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label27 %></label>
                        <textarea name="" class="input-text input-text-outline" id="note_input" rows="4"></textarea>
                    </div>

                    <div class="mb-2">
                        <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.select_file %></label>
                        <input type="file" class="input-text" id="document_input">
                    </div>

                </div>

                <div class="col-lg-12 col-md-12">
                    <div class="mt-3">
                        <input type="submit" class="btn btn-primary btn-sm shadow" value="<%= UI_DISPLAY_LANG.views.pages.global.save_changes_button %>">
                    </div>
                </div>

            </div>  

        </form>
        
	</div>
</div>

<script>

$(function()
{

var page_container = $('#add_funds_to_fundboxes_container');
if ( page_container[0] == undefined )
    return;

var ERROR_BOX = page_container.find('#ERROR_BOX');

var create_form = page_container.find('#create_form')
// Sender
var owner_total = create_form.find('#owner_total')

var amount_input = create_form.find('#amount_input')
var amount_label = create_form.find('#amount_label')
var reason_input = create_form.find('#reason_input')
var note_input = create_form.find('#note_input')
var document_input = create_form.find('#document_input')
var operation_select = create_form.find('#operation_select')
// submit
create_form.on('submit', async e =>
{
    e.preventDefault()
    var target = create_form
    var params = new FormData

    var owner = getOwner()
    var ownerId = owner.id
    var ownerName = owner.name
    var ownerType = owner.type

    var sourceId = USER_CONFIG.employee_id
    var sourceName = USER_CONFIG.employee_name

    var amount = amount_input.val()
    var reason = reason_input.val()
    var note = note_input.val()

    params.append('owner_id', ownerId)
    params.append('owner_name', ownerName)
    params.append('owner_type', ownerType)
    params.append('source_id', sourceId)
    params.append('source_name', sourceName)
    params.append('owner_type', ownerType)
    params.append('amount', amount)
    params.append('reason', reason)
    params.append('note', note)
    params.append('operation', operation_select.find(':selected').val())
    if ( document_input[0].files.length > 0 ) params.append('document', document_input[0].files[0])
    
    SectionLoader(create_form)
    var res = await FUNDBOX_MODEL.actions_funds_store(params)
    SectionLoader(create_form, '')

    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
    CreateToast('PS', res.message, '')
    if ( res.code == 404 ) return
    //
    target.find('input[type="text"]').val('')
    amount_input.val(0.00)
    amount_input.trigger('input')
    //
    owner_displayOwnerTotal()
})
// Owner
// enter amount
amount_input.on('input', e =>
{
    var selected = operation_select.find(':selected')
    var amount = 0

    if ( selected.val() == 'add' )
    {
        amount_input.removeClass('input-danger').addClass('input-success')
        amount_label.removeClass('text-danger').addClass('text-success')
        amount = '+('+moneyFormat(amount_input.val())+')'
    }
    else if ( selected.val() == 'subtract' )
    {
        amount_input.removeClass('input-success').addClass('input-danger')
        amount_label.removeClass('text-success').addClass('text-danger')
        amount = '-('+moneyFormat(amount_input.val())+')'
    }

    amount_label.text( amount )
})
// select opration
operation_select.on('change', e =>
{
    amount_input.trigger('input')
})
// get owner
function getOwner()
{
    var owner = {
        id: USER_CONFIG.employee_id,
        name: USER_CONFIG.employee_name,
        type: 'employees',
    }

    if ( USER_CONFIG.type.employee_type_code == EMP_TYPE_DISTRIBUTOR )
        owner.type = 'distributors'

    return owner
}
// owner_displayOwnerTotal 
owner_displayOwnerTotal()
async function owner_displayOwnerTotal()
{
    var owner = getOwner()

    owner_total.text('0.00')
    var res = await FUNDBOX_MODEL.actions_owner_show({
        owner_id: owner.id,
        owner_type: owner.type,
    })
    
    if ( res.code == 404 ) return

    owner_total.text( moneyFormat(res.data.total) )
}


})

</script>