<div class="container-fluid" id="createhealthyKitchenPostContainer">
    <div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.add_clinics.sectionTitle %></h1>
	</div>
	<div class="mt-3 app-block" id="wrapper01">
		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>

		<div id="create_form">
			<div class="row gx-4 gy-4">
				<div class="col-lg-12 col-md-12 col-sm-12">
					<div class="">
						<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label1 %></label>
						<input type="text" class="input-text input-text-outline" id="name_input">
					</div>	
				</div>
                <div class="col-lg-12 col-md-12 col-sm-12">
					<div class="">
						<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label23 %></label>
						<textarea rows="4" class="input-text input-text-outline" id="description_input"></textarea>
					</div>	
				</div>
				<div class="col-lg-12 col-md-12 col-sm-12">
					<div class="">
						<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label20 %></label>
                        <div id="ingredients_list">
                            <input type="text" class="w-100 input-text border-bottom-forced mb-3" placeholder="<%= UI_DISPLAY_LANG.views.pages.global.placeholder6 %>">
                            <ul class="list-group list-group-flush overflow-y-auto overflow-x-hidden max-height-200px">
                            
                            </ul>
                        </div>
					</div>	
				</div>
                <div class="col-lg-12 col-md-12 col-sm-12">
					<div class="">
						<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label21 %></label>
                        <div id="preparation_steps_list">
                            <input type="text" class="w-100 input-text border-bottom-forced mb-3" placeholder="<%= UI_DISPLAY_LANG.views.pages.global.placeholder6 %>">
                            <ul class="list-group list-group-flush overflow-y-auto overflow-x-hidden max-height-200px">
                            
                            </ul>
                        </div>
					</div>	
				</div>
                <div class="col-lg-12 col-md-12 col-sm-12">
					<div class="row gx-4 gy-4">

                        <div class="col-3">
                            <div class="">
                                <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.select_image %></label>
                                <input type="file" class="input-text input-text-outline" id="image_input" accept="image/*">
                            </div>	
                        </div>
                        <div class="col">
                            <img src="../assets/img/utils/placeholder.jpg" data-src="../assets/img/utils/placeholder.jpg" class="img-01 img-thumbnail" id="image_preview" data-croppable="true" alt="">
                        </div>

                    </div>
				</div>
			</div>
			<div class="mt-3">
				<button class="btn btn-primary btn-sm shadow" id="save_changes_button">
                    <%= UI_DISPLAY_LANG.views.pages.global.save_changes_button %>
                </button>
			</div>
		</div>

	</div>
</div>


<script>

$(async function()
{

var page_container = $('#createhealthyKitchenPostContainer');
if ( !page_container[0] ) return;

var ERROR_BOX = page_container.find('#ERROR_BOX');
var create_form = page_container.find('#create_form');
var save_changes_button = create_form.find('#save_changes_button');
var name_input = create_form.find('#name_input');
var description_input = create_form.find('#description_input');
var ingredients_list = create_form.find('#ingredients_list');
var preparation_steps_list = create_form.find('#preparation_steps_list');
var image_input = create_form.find('#image_input');
var image_preview = create_form.find('#image_preview');


var HealthyKitchenPostObject = sessionData(true)

// submit
save_changes_button.on('click', async e =>
{
    SectionLoader(create_form)
    var form_data = new FormData

    HealthyKitchenPostObject.name = name_input.val()
    HealthyKitchenPostObject.description = description_input.val()
    HealthyKitchenPostObject.ingredients = ingredients()
    HealthyKitchenPostObject.preparation_steps = preparationSteps()
    if ( image_input[0].files.length > 0 )
        form_data.append('image', image_input[0].files[0])

    form_data.append('RequestObject', JSON.stringify(HealthyKitchenPostObject))

    // update
    if ( HealthyKitchenPostObject.id )
    {
        var res = await HEALTHY_KITCHEN_POST_MODEL.update(form_data)
        SectionLoader(create_form, '')
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
        resetFields()
        return
    }
    // store
    var res = await HEALTHY_KITCHEN_POST_MODEL.store(form_data)
    SectionLoader(create_form, '')
    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
    resetFields()
})
// add ingredients
ingredients_list.find('input[type="text"]').on('keydown', e =>
{
    var target = $(e.target)
    
    if ( e.key == 'Enter' )
    {
        addIngredient({
            name: $.trim(target.val())
        })
        target.val('')
    }
})
// remove ingredient
ingredients_list.on('click', e =>
{
    var target = $(e.target)
    if ( target.data('role') == 'delete' )
    {
        var parent = target.closest('[data-role="item"]')
        parent.remove()
    }
})
// add preparation step
preparation_steps_list.find('input[type="text"]').on('keydown', e =>
{
    var target = $(e.target)
    
    if ( e.key == 'Enter' )
    {
        addPreparationStep({
            name: $.trim(target.val())
        })
        target.val('')
    }
})
// remove preparation step
preparation_steps_list.on('click', e =>
{
    var target = $(e.target)
    if ( target.data('role') == 'delete' )
    {
        var parent = target.closest('[data-role="item"]')
        parent.remove()
    }
})
// select image
image_input.on('change', async e =>
{
    if ( image_input[0].files.length == 0 ) return

    var data_url = await imageToDataURL(image_input[0].files[0])
    previewImage(data_url)
})
//
displayOne();
async function displayOne()
{
	if ( HealthyKitchenPostObject.id == null )
		return;

	name_input.val( HealthyKitchenPostObject.name )
    description_input.val( HealthyKitchenPostObject.description )
    // ingredients
    for (let i = 0; i < HealthyKitchenPostObject.ingredients.length; i++) 
    {
        const item = HealthyKitchenPostObject.ingredients[i];
        addIngredient({
            name: item.name
        })
    }
    // preparation steps
    for (let i = 0; i < HealthyKitchenPostObject.preparation_steps.length; i++) 
    {
        const item = HealthyKitchenPostObject.preparation_steps[i];
        addPreparationStep({
            name: item.name
        })
    }
    // image
    previewImage(HealthyKitchenPostObject.image.url)
}
// add ingredient
function addIngredient(options)
{
    if ( options.name == '' ) return
    var html = `<li class="d-flex is-justify-content-space-between list-group-item" data-role="item" data-name="${options.name}">
                    <span>${ options.name }</span>
                    <a class="btn-close" data-role="delete"></a>
                </li>`

    ingredients_list.find('ul').append(html)
}
// ingredient items
function ingredients()
{
    var list = []

    var items = ingredients_list.find('[data-role="item"]')
    for (let i = 0; i < items.length; i++) 
    {
        const item = $(items[i])
        list.push({
            name: item.data('name')
        })
    }

    return list
}
// clear ingredients
function clearIngredients()
{
    ingredients_list.find('ul').html('')
}
// add preparation step
function addPreparationStep(options)
{
    if ( options.name == '' ) return

    var html = `<li class="d-flex is-justify-content-space-between list-group-item" data-role="item" data-name="${options.name}">
                    <span>${ options.name }</span>
                    <a class="btn-close" data-role="delete"></a>
                </li>`

    preparation_steps_list.find('ul').append(html)
}
// preparation step
function preparationSteps()
{
    var list = []

    var items = preparation_steps_list.find('[data-role="item"]')
    for (let i = 0; i < items.length; i++) 
    {
        const item = $(items[i])
        list.push({
            name: item.data('name')
        })
    }

    return list
}
// clear ingredients
function clearPreparationSteps()
{
    preparation_steps_list.find('ul').html('')
}
// reset
function resetFields()
{
    clearIngredients()
    clearPreparationSteps()
    create_form.find('input').val('')
    create_form.find('textarea').val('')
    image_preview.attr('src', image_preview.data('src'))
    HealthyKitchenPostObject.id = null
}
// preview image
async function previewImage(url)
{
    image_preview.attr('src', url)
}


})

</script>