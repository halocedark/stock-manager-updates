<div class="container-fluid" id="editProductsContainer">
	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.add_products.sectionTitle %></h1>
	</div>
	<div class="mt-3 app-block">
		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>
		<div id="wrapper01">
			<form action="#" id="addForm">

                <div class="mb-2">
                    <%- include(`${SETTINGS.UI_Settings.MAIN_DIR_NAME}/views/templates/select-categories.template.ejs`, {
                        eventsReceiverId: 'editProductsContainer',
                    }) -%>
                </div>

                <div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label38 %></label>
                    <input type="text" class="input-text" id="codeInput" value="">
                </div>

                <div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_products.form01.label01 %></label>
                    <input type="text" class="input-text" id="nameInput" value="">
                </div>

				<div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_products.form01.label02 %></label>
					<textarea name="" id="descInput" class="input-text" rows="4"></textarea>
                </div>

				<div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label40 %></label>
                    <input type="number" step="any" min="0" class="input-text" id="buypriceInput" value="0">
                </div>

                <div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label41 %></label>
                    <input type="number" step="any" min="0" class="input-text" id="priceInput" value="0">
                </div>

                <div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label44 %></label>
                    <input type="number" step="any" min="0" class="input-text" id="wholesalePriceInput" value="0">
                </div>

                <div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label45 %></label>
                    <input type="number" step="any" min="0" class="input-text" id="halfWholesalePriceInput" value="0">
                </div>

                <div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_products.form01.label04 %></label>
                    <input type="number" step="any" min="0" class="input-text" id="quantityInput" value="1">
                </div>

				<div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_products.form01.label06 %></label>
                    <input type="text" step="any" class="input-text" id="barcodeInput" value="">
                </div>

                <div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label47 %></label>
                    <input type="date" step="any" class="input-text" id="expireDateInput" value="">
                </div>

                <div class="mt-2 text-center">
					<div class="row gx-2 gy-2 d-inline-block">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_products.form01.label05 %></label>
                            <input type="file" class="input-text" id="imageInput" value="" accept="image/*">
                        </div>
                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <img src="assets/img/utils/placeholder.jpg" id="previewIMG" class="img-03 img-thumbnail" alt="">
                        </div>
                    </div>
				</div>

				<div class="mt-3">
                    <input type="submit" class="btn btn-primary btn-sm shadow" value="<%= UI_DISPLAY_LANG.views.pages.add_products.form01.submitBTN01 %>">
				</div>
                
			</form>	
		</div>
	</div>
</div>

<script>

$(async function()
{

var page_container = $('#editProductsContainer');

if ( !page_container[0] )
    return;

var ERROR_BOX = page_container.find('#ERROR_BOX');
var addForm = page_container.find('#addForm');
var select_categories_template_category_select = addForm.find('#select_categories_template_category_select');
var codeInput = addForm.find('#codeInput');
var nameInput = addForm.find('#nameInput');
var descInput = addForm.find('#descInput');
var quantityInput = addForm.find('#quantityInput');
var priceInput = addForm.find('#priceInput');
var wholesalePriceInput = addForm.find('#wholesalePriceInput');
var halfWholesalePriceInput = addForm.find('#halfWholesalePriceInput');
var buypriceInput = addForm.find('#buypriceInput');
var barcodeInput = addForm.find('#barcodeInput');
var expireDateInput = addForm.find('#expireDateInput');
var imageInput = addForm.find('#imageInput');
var previewIMG = addForm.find('#previewIMG');

var options = {
    id: sessionData().id
}
// clear session data
sessionData(true)
// addForm
addForm.off('submit');
addForm.on('submit', async e =>
{
    e.preventDefault();
    var data = {
        productId: options.id,
        productName: nameInput.val(),
        productDesc: descInput.val(),
        productBuyPrice: buypriceInput.val(),
        productPrice: priceInput.val(),
        productWholesalePrice : wholesalePriceInput.val(),
        productHalfWholesalePrice : halfWholesalePriceInput.val(),
        productQuantity: quantityInput.val(),
        productBarcode: barcodeInput.val(),
        expired_at: expireDateInput.val(),
        category_id: select_categories_template_category_select.find(':selected').val(),
        category_name: select_categories_template_category_select.find(':selected').text(),
    };
    if ( imageInput[0].files.length > 0 )
        data.productImage = imageInput[0].files[0];
    SectionLoader(addForm);
    var response = await PRODUCT_MODEL.update(data);
    SectionLoader(addForm, '');
    if ( response.code == 404 )
    {
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
        return;
    }
    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
    imageInput.val(null);
});
// select image
imageInput.off('change');
imageInput.on('change', e =>
{
    if ( imageInput[0].files.length == 0 )
        return;

    previewIMG.attr('src', imageInput[0].files[0].path);
});
// barcode
listenForBarcodeScanner(code =>
{
    if ( barcodeInput.is(':focus') )
        barcodeInput.val(code);
});
// display info
displayInfo();
async function displayInfo()
{
    SectionLoader(addForm);
    var response = await PRODUCT_MODEL.show(options.id);
    SectionLoader(addForm, '');
    var data = response.data;
    codeInput.val( data.productCode )
    nameInput.val(data.productName);
    descInput.val(data.productDesc);
    quantityInput.val(data.productQuantity);
    buypriceInput.val( data.productBuyPrice )
    priceInput.val(data.productPrice);
    wholesalePriceInput.val( data.productWholesalePrice )
    halfWholesalePriceInput.val( data.productHalfWholesalePrice )
    barcodeInput.val(data.productBarcode);
    expireDateInput.val(formatDateTimeToDate(data.expired_at))
    previewIMG.attr('src', data.image ? data.image.url : 'assets/img/utils/placeholder.jpg' );

    // category selected
    $(document).off('category-selected').on('category-selected', e =>
    {
        var detail = e.originalEvent.detail

        setOptionSelected(select_categories_template_category_select, data.category_id)
    })

}

})

</script>