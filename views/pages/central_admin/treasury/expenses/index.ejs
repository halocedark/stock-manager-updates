<div class="container-fluid" id="treasuryCashoutsCentralAdminContainer">
	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.treasury_cashouts.sectionTitle %></h1>
	</div>
	<div class="mt-3">
		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>
		<div class="table-nav">
			<div class="row gx-2 gy-2">
				<div class="col-lg-12 col-md-12 col-sm-12">
					<button class="btn btn-danger btn-sm" id="deleteSelectedBTN"><%= UI_DISPLAY_LANG.views.pages.treasury_cashouts.btn01 %></button>
				</div>
				<div class="col-lg-12 col-md-12 col-sm-12">
					<div class="form-field-01 mt-2">
						<div class="form-field-input-holder">
							<div class="form-field-label"><%= UI_DISPLAY_LANG.views.pages.treasury_cashouts.label01 %></div>
							<input type="date" id="fromDateInput" class="form-field-input">
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="pagination" class="my-3 flex flex-center"></div>
		<div class="table-div">
			<div class="utable shadowed" id="tableElement">
				<div class="thead">
					<div class="td">#</div>
					<div class="td"><%= UI_DISPLAY_LANG.views.pages.treasury_cashouts.th01 %></div>
					<div class="td"><%= UI_DISPLAY_LANG.views.pages.treasury_cashouts.th02 %></div>
					<div class="td"><%= UI_DISPLAY_LANG.views.pages.treasury_cashouts.th03 %></div>
					<div class="td"><%= UI_DISPLAY_LANG.views.pages.treasury_cashouts.th04 %></div>
					<div class="td"></div>
					<div class="td"><%= UI_DISPLAY_LANG.views.pages.treasury_cashouts.th05 %></div>
				</div>
				<div class="tbody">
					<!--
					<div class="tr">
						<div class="td">
							<input type="checkbox" class="form-check-input" data-role="CHECK" data-id="">
						</div>
						<div class="td">in</div>
						<div class="td">out</div>
						<div class="td">reason</div>
						<div class="td">note</div>
						<div class="td">date</div>
					</div>
					-->
				</div>
			</div>
		</div>
	</div>
</div>

<script>

$(function()
{

var treasuryCashoutsCentralAdminContainer = $('#treasuryCashoutsCentralAdminContainer');
if ( treasuryCashoutsCentralAdminContainer[0] == undefined )
    return;

var ERROR_BOX = treasuryCashoutsCentralAdminContainer.find('#ERROR_BOX');

var deleteSelectedBTN = treasuryCashoutsCentralAdminContainer.find('#deleteSelectedBTN');
var fromDateInput = treasuryCashoutsCentralAdminContainer.find('#fromDateInput');
var pagination = treasuryCashoutsCentralAdminContainer.find('#pagination');
var tableElement = treasuryCashoutsCentralAdminContainer.find('#tableElement');

var now = new Date();
fromDateInput.val( date_time.format(now, 'YYYY-MM-DD') );
// tableElement click
tableElement.off('click');
tableElement.on('click', e =>
{
    var target = $(e.target);

    if ( target.data('role') == 'PREVIEW_DOC' )
    {
        e.preventDefault();
        PreviewFileDialog({
            url: target.attr('href')
        });
    }
});
// delete selected
deleteSelectedBTN.off('click');
deleteSelectedBTN.on('click', e =>
{
    PromptConfirmDialog().then(async c =>
    {
        // disply loader
        SectionLoader(tableElement);
        var response = await TREASURY_MODEL.expenses_batchDelete(selectedRows());
        // hide loader
        SectionLoader(tableElement, '');
        if ( response.code == 404 )
        {
            ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
            return;
        }
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
        //
        displayAll();
    });
});
// filter
fromDateInput.off('change');
fromDateInput.on('change', async e =>
{
    var val = fromDateInput.val();
    var TreasuryObject = {
        clinicId: parseInt(0),
        date: val
    };
    // disply loader
    SectionLoader(tableElement);
    var response = await TREASURY_MODEL.expenses_filterByDate(TreasuryObject);
    // hide loader
    SectionLoader(tableElement, '');
    // clear html
    tableElement.find('.tbody').html('');
    if ( response.code == 404 )
        return;

    var data = response.data;
    var html = '';
    $.each(data, (k,v) =>
    {
        var expense_file = (v.expense_file_object) ? JSON.parse(v.expense_file_object).url : '';
        var expense_file_link = ''; 
        var expense_file_view = '';
        if ( expense_file != '' )
        {
            expense_file_link = `<a href="${expense_file}" download="${path.basename(expense_file)}"><i class="fas fa-download"></i></a>`;
            expense_file_view = `<a href="${expense_file}" data-role="PREVIEW_DOC"><i class="fas fa-eye no-pointer" ></i></a>`;
        }
            
        html += `<div class="tr">
                    <div class="td">
                        <input type="checkbox" class="form-check-input pointer" data-role="CHECK" data-id="${v.expense_id}">
                    </div>
                    <div class="td">${v.expense_in}</div>
                    <div class="td">${v.expense_out}</div>
                    <div class="td">${v.expense_reason}</div>
                    <div class="td">${v.expense_note}</div>
                    <div class="td pointer">
                        <div>${expense_file_link}</div>
                        <div>${expense_file_view}</div>
                    </div>
                    <div class="td">${v.expense_date} | ${v.expense_time}</div>
                </div>PAG_SEP`;
    });
    // add html
    var options = {
        data: html.split('PAG_SEP')
    };
    new SmoothPagination(pagination, tableElement.find('.tbody'), options);
});
displayAll();
// display all
function displayAll()
{
    fromDateInput.trigger('change');
}
// selected rows
function selectedRows()
{
    var list = [];
    var items = tableElement.find('[data-role="CHECK"]');
    for (var i = 0; i < items.length; i++) 
    {
        var check = $(items[i]);
        if ( check.is(':checked') )
            list.push({ id: check.data('id') });
    }

    return list;
}

})

</script>