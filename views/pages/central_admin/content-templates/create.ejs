<div class="container-fluid" id="create_content_template_Container">
	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.send_message.sectionTitle %></h1>
	</div>

    <div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
        <img src="assets/img/utils/info.png" class="alert-icon" alt="">
        <div class="alert-text" id="text"></div>
    </div>

	<div class="mt-3">
		
        <div class="row gx-4 gy-4">

            <div class="col-lg-6 col-md-6" data-perm="create_content_templates">

                <div class="app-block">

                    <form action="#" id="create_form">

                        <div class="mb-2">

                            <%- include(`${SETTINGS.UI_Settings.MAIN_DIR_NAME}/views/templates/select-clinics.template.ejs`) -%>

                        </div>

                        <div class="mb-2">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label1 %></label>
                            <input type="text" class="input-text input-text-outline" id="name_input">
                        </div>
            
                        <div class="mb-2">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label4 %></label>
                            <textarea name="" class="input-text input-text-outline" id="body_input" rows="4"></textarea>
                        </div>
                        
                        <div class="">
                            <input type="submit" class="btn btn-primary btn-sm" value="<%= UI_DISPLAY_LANG.views.pages.global.save_changes_button %>">
                        </div>
            
                    </form>

                </div>

            </div>

            <div class="col-lg-6 col-md-6" data-perm="view_content_templates">

                <div class="app-block">

                    <div class="table-nav">

                        <div class="row gx-4 gy-4">
    
                            <div class="col-lg-6 col-md-6">
    
                                <div class="form-field-01">
                                    <div class="form-field-icon-holder" id="search_btn">
                                        <img src="assets/img/utils/search.svg" class="form-field-icon" alt="">	
                                    </div>
                                    <div class="form-field-input-holder">
                                        <input type="text" id="search_input" class="form-field-input" placeholder="<%= UI_DISPLAY_LANG.views.pages.global.placeholder5 %>">
                                    </div>
                                </div>
    
                            </div>
    
                        </div>
    
                    </div>
    
                    <div id="pagination" class="flex flex-center"></div>

                    <div class="utable shadowed" id="table_element">
                        <div class="thead">
                            <div class="td">#</div>
                            <div class="td"><%= UI_DISPLAY_LANG.views.pages.global.th1 %></div>
                            <div class="td"><%= UI_DISPLAY_LANG.views.pages.global.th4 %></div>
                            <div class="td"></div>
                        </div>
                        <div class="tbody">
                            <!--
                            <div class="tr" data-role="row" data-id="">
                                <div class="td">
                                    <input type="checkbox" class="form-check-input pointer" data-role="CHECK">
                                </div>
                                <div class="td">name</div>
                                <div class="td">body</div>
                                <div class="td">
                                    <button class="btn btn-primary btn-sm pointer" data-role="UPDATE" data-aptid="">
                                        <span class="no-pointer"><i class="fas fa-edit"></i></span>
                                    </button>		
                                </div>
                            </div>
                            -->
                        </div>
                    </div>

                </div>

            </div>

        </div>

	</div>
</div>

<script>

    $(function()
    {

        var page_container = $('#create_content_template_Container')
        if ( !page_container[0] ) return

        var ERROR_BOX = page_container.find('#ERROR_BOX')

        var create_form = page_container.find('#create_form')
        var clinic_select = create_form.find('#clinic_select')
        var name_input = create_form.find('#name_input')
        var body_input = create_form.find('#body_input')

        var search_btn = page_container.find('#search_btn')
        var search_input = page_container.find('#search_input')
        var pagination = page_container.find('#pagination')
        var table_element = page_container.find('#table_element')

        console.log( clinic_select[0] )
        var ContentTemplateObject = sessionData(true)
        // table_element
        table_element.on('click', async e =>
        {
            var target = $(e.target)

            if ( target.data('role') == 'UPDATE' )
            {
                var parent = target.closest('[data-role="row"]')
                
                parent.addClass('disabled')
                var res = await CONTENT_TEMPLATE_MODEL.show({
                    id: parent.data('id')
                })
                parent.removeClass('disabled')
                if ( res.code == 404 ) return

                ContentTemplateObject = res.data
                displayInfo()
            }
            else if ( target.data('role') == 'DELETE' )
            {
                var parent = target.closest('[data-role="row"]')
                
                PromptConfirmDialog().then(async c =>
                {
                    parent.addClass('disabled')
                    var res = await CONTENT_TEMPLATE_MODEL.delete({
                        id: parent.data('id')
                    })
                    parent.removeClass('disabled')
                    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
                    if ( res.code == 404 ) return

                    displayAll({
                        method_type: 'local_search',
                        clinicId: clinic_select.find(':selected').val(),
                        query: search_input.val(),
                        type: 'certificate'
                    })
                })
            }
        })
        // submit
        create_form.on('submit', async e =>
        {
            e.preventDefault()
            var target = create_form

            ContentTemplateObject.clinicId = clinic_select.find(':selected').val()
            ContentTemplateObject.name = name_input.val()
            ContentTemplateObject.body = body_input.val()
            ContentTemplateObject.type = 'certificate'

            SectionLoader(create_form)
            // update
            if ( ContentTemplateObject.id )
            {
                var res = await CONTENT_TEMPLATE_MODEL.update(ContentTemplateObject)
                SectionLoader(create_form, '')
                ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)

                if ( res.code == 404 ) return

                target.find('input[type="text"], textarea').val('')
                ContentTemplateObject.id = null
                displayAll({
                    method_type: 'local_search',
                    clinicId: clinic_select.find(':selected').val(),
                    query: search_input.val(),
                    type: 'certificate'
                })
                return
            }
            // store
            var res = await CONTENT_TEMPLATE_MODEL.store(ContentTemplateObject)
            SectionLoader(create_form, '')
            ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)

            if ( res.code == 404 ) return

            target.find('input[type="text"], textarea').val('')

            displayAll({
                method_type: 'local_search',
                clinicId: clinic_select.find(':selected').val(),
                query: search_input.val(),
                type: 'certificate'
            })
        })
        // select clinic
        clinic_select.on('change', e =>
        {
            displayAll({
                method_type: 'local_search',
                clinicId: clinic_select.find(':selected').val(),
                query: search_input.val(),
                type: 'certificate'
            })
        })
        // search
        search_btn.on('click', e =>
        {
            search_input.trigger('keyup')
        })
        search_input.on('click', e =>
        {
            displayAll({
                method_type: 'local_search',
                clinicId: '*',
                query: search_input.val(),
                type: 'certificate'
            })
        })
        .on('keyup', e =>
        {
            displayAll({
                method_type: 'local_search',
                clinicId: '*',
                query: search_input.val(),
                type: 'certificate'
            })
        })
        // display all
        displayAll({
            method_type: 'local_search',
            clinicId: clinic_select.find(':selected').val(),
            query: search_input.val(),
            type: 'certificate'
        })
        async function displayAll(params)
        {
            table_element.find('.tbody').html('')
            if ( params.method_type == 'local_search' )
                var res = await CONTENT_TEMPLATE_MODEL.local_search(params)

            if ( res.code == 404 ) return

            var data = res.data
            var html = ''

            $.each(data, (k,v) =>
            {
                html += `<div class="tr" data-role="row" data-id="${v.id}">
                                <div class="td">
                                    <input type="checkbox" class="form-check-input pointer" data-role="CHECK">
                                </div>
                                <div class="td">${ strSnippet(v.name) }</div>
                                <div class="td">${ strSnippet(v.body) }</div>
                                <div class="td pointer overflow-visible">
                                    <div class="dropdown">
                                        <a href="#" class="dropdown-toggle" type="button" id="dropdownMenuButton_${v.id}" data-bs-toggle="dropdown" aria-expanded="false">
                                            ${FUI_DISPLAY_LANG.views.pages.global.label30}
                                        </a>
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton_${v.id}">
                                            <li><a class="dropdown-item" href="#" data-role="UPDATE" data-perm="update_content_templates">${FUI_DISPLAY_LANG.views.pages.global.actions.update}</a></li>
                                            <li><a class="dropdown-item" href="#" data-role="DELETE" data-perm="delete_content_templates">${FUI_DISPLAY_LANG.views.pages.global.actions.delete}</a></li>
                                        </ul>
                                    </div>		
                                </div>
                            </div>PAG_SEP`
            })

            new SmoothPagination(pagination, table_element.find('.tbody'), {
                data: html.split('PAG_SEP')
            })
        }
        // show
        displayInfo()
        function displayInfo()
        {
            if ( !ContentTemplateObject.id ) return
            name_input.val(ContentTemplateObject.name)
            body_input.val(ContentTemplateObject.body)
        }
    })

</script>