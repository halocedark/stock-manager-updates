<div class="container-fluid" id="createMedicalAnalysis_page">
	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.add_patients.sectionTitle %></h1>
	</div>
	<div class="mt-3 app-block" id="wrapper01">
		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>

        <div class="mb-5">

            <h1 class="h3"><%= UI_DISPLAY_LANG.views.pages.global.text3 %></h1>

            <form action="#" id="create_category_form">
                <div class="row gx-4 gy-4">
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label1 %></label>
                            <input type="text" required class="input-text input-text-outline" id="category_name_input">
                        </div>	
                    </div>
                </div>
                <div class="mt-3">
                    <input type="submit" class="btn btn-primary btn-sm shadow" value="<%= UI_DISPLAY_LANG.views.pages.global.save_changes_button %>">
                </div>
            </form>

        </div>

		<div>

            <h1 class="h3"><%= UI_DISPLAY_LANG.views.pages.global.text4 %></h1>

            <form action="#" id="create_analysis_form">
                <div class="row gx-4 gy-4">
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="section">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label10 %></label>
                            <div class="d-flex">
                                <select name="" class="input-text" id="category_select">
                                
                                </select>
                                <button class="btn btn-primary btn-sm" type="button" id="update_category">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>	
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label1 %></label>
                            <input type="text" class="input-text input-text-outline" id="name_input">
                        </div>	
                    </div>
                </div>
                <div class="mt-3">
                    <input type="submit" class="btn btn-primary btn-sm shadow" value="<%= UI_DISPLAY_LANG.views.pages.global.save_changes_button %>">
                </div>
            </form>

        </div>

	</div>
</div>

<script>

$(function()
{

var page_container = $('#createMedicalAnalysis_page')

if ( !page_container[0] ) return

var ERROR_BOX = page_container.find('#ERROR_BOX')

// categories
var create_category_form = page_container.find('#create_category_form')
var category_name_input = create_category_form.find('#category_name_input')
// medical analysis
var create_analysis_form = page_container.find('#create_analysis_form')
var category_select = create_analysis_form.find('#category_select')
var update_category = create_analysis_form.find('#update_category')
var name_input = create_analysis_form.find('#name_input')

var CategoryObject = {
    id: null
}
var MedicalAnalysisObject = {
    id: sessionData(true).id
}

let categ_promise

create_category_form.on('submit', async e =>
{
    e.preventDefault()
    var target = $(e.target)

    if ( CategoryObject.id != null )
    {
        var res = await MEDICAL_ANALYSIS_CATEGORY_MODEL.update({
            id: CategoryObject.id,
            name: category_name_input.val()
        })

        if ( res.code == 404 )
        {
            ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
            return
        }

        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
        displayCategories()
        target[0].reset()
        CategoryObject.id = null
        return
    }

    var res = await MEDICAL_ANALYSIS_CATEGORY_MODEL.store({
        name: category_name_input.val()
    })

    if ( res.code == 404 )
    {
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
        return
    }

    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
    displayCategories()
    target[0].reset()
})
// update category
update_category.on('click', e =>
{
    var selected = category_select.find(':selected')
    CategoryObject.id = selected.val()
    category_name_input.val( selected.text() )
})

create_analysis_form.on('submit', async e =>
{
    e.preventDefault()
    var target = $(e.target)

    if ( MedicalAnalysisObject.id != null )
    {
        var res = await MEDICAL_ANALYSIS_MODEL.update({
            id: CategoryObject.id,
            medical_analysis_category_id: category_select.find(':selected').val(),
            name: name_input.val()
        })

        if ( res.code == 404 )
        {
            ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
            return
        }

        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
        target.find('input[type="text"]').val('')
        MedicalAnalysisObject.id = null
        return
    }

    var res = await MEDICAL_ANALYSIS_MODEL.store({
        medical_analysis_category_id: category_select.find(':selected').val(),
        name: name_input.val()
    })

    if ( res.code == 404 )
    {
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
        return
    }

    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
    target.find('input[type="text"]').val('')
})

// display categories
displayCategories()
async function displayCategories()
{
    categ_promise = MEDICAL_ANALYSIS_CATEGORY_MODEL.index()
    var res = await categ_promise

    if ( res.code == 404 ) return

    var html = ''

    $.each(res.data, (k,v) =>
    {
        html += `<option value="${v.id}">${v.name}</option>`
    })
    
    category_select.html(`<option value="">${ FUI_DISPLAY_LANG.views.pages.global.label11 }</option>`)
    category_select.append(html)
}

// display medical analysis
displayMedicalAnalysis()
async function displayMedicalAnalysis()
{
    if ( MedicalAnalysisObject.id == null ) return;

    await categ_promise

    var res = await MEDICAL_ANALYSIS_MODEL.show({
        id: MedicalAnalysisObject.id
    })
    if ( res.code == 404 ) return

    var data = res.data

    setOptionSelected(category_select, data.medical_analysis_category_id)
    name_input.val(data.name)
}

})

</script>

