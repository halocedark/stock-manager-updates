<div class="container-fluid" id="educational_presentations_container">

	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.add_employees.sectionTitle %></h1>
	</div>

    <div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
        <img src="assets/img/utils/info.png" class="alert-icon" alt="">
        <div class="alert-text" id="text"></div>
    </div>

	<div class="mt-3 mb-3" data-perm="create_educational_presentations">

		<div class="row">

            <div class="col-lg col-md">

                <div class="app-block">
                    <form action="#" id="create_form">
			
                        <div class="mb-2">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label1 %></label>
                            <input type="text" class="input-text input-text-outline" name="caption" id="caption_input">
                        </div>
            
                        <div class="mb-2">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label80 %></label>
                            <input type="text" class="input-text input-text-outline" name="description" id="description_input">
                        </div>
            
                        <div class="mb-2">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.select_file %></label>
                            <input type="file" class="input-text input-text-outline js_file_input_has_progress" id="file_input">
                        </div>
            
                        <div class="mt-3">
                            <input type="submit" class="btn btn-primary btn-sm shadow" value="<%= UI_DISPLAY_LANG.views.pages.global.save_changes_button %>">
                        </div>
            
                    </form>
                </div>

            </div>

        </div>

	</div>

    <div class="" data-perm="view_educational_presentations">

        <div class="table-nav">

            <div class="row gy-3">

                <div class="col-lg-12">
                    <button class="btn btn-danger btn-sm" id="deleteSelectedBTN" data-perm="delete_educational_presentations">
                        <%= UI_DISPLAY_LANG.views.pages.global.delete_selected_button %>
                    </button>
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12">
                    <%- include(`${SETTINGS.UI_Settings.MAIN_DIR_NAME}/views/templates/searchbox.template.ejs`, {
                        searchBtnId: 'search_btn',
                        searchInputId: 'search_input',
                    }) -%>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-12">
                    <%- include(`${SETTINGS.UI_Settings.MAIN_DIR_NAME}/views/templates/start-end-date.template.ejs`, {
                        dateStartId: 'date_start_input',
                        dateEndId: 'date_end_input',
                    }) -%>
                </div>

            </div>

        </div>

        <div id="pagination" class="my-3 flex flex-center"></div>

		<div class="row gx-4 gy-3" id="tableElement">
			<!--
			<div class="col-lg-4 col-md-6 col-sm-12">
				<div class="card hover-shadow" data-role="APT" data-aptid="" style="cursor: pointer;">
					<div class="card-body no-pointer">
						<div class="h5">قسم الحجامة</div>
						<div class="text-02">(4) جلسات</div>
					</div>
				</div>
			</div>
			-->
		</div>

	</div>

</div>

<script>

$(async function()
{


var page_container = $('#educational_presentations_container')
if ( !page_container[0] ) return

var ERROR_BOX = page_container.find('#ERROR_BOX')

var create_form = page_container.find('#create_form')
var caption_input = create_form.find('#caption_input')
var description_input = create_form.find('#description_input')
var file_input = create_form.find('#file_input')

var deleteSelectedBTN = page_container.find('#deleteSelectedBTN')
var search_btn = page_container.find('#search_btn')
var search_input = page_container.find('#search_input')
var date_start_input = page_container.find('#date_start_input')
var date_end_input = page_container.find('#date_end_input')
var pagination = page_container.find('#pagination')
var tableElement = page_container.find('#tableElement')

var PresentationObject = {}

// set primary dates
date_start_input.val( CURRENT_DATE );
date_end_input.val( CURRENT_DATE );

create_form.on('submit', async e =>
{
    e.preventDefault()

    if ( file_input[0].files.length == 0 )
    {
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(FUI_DISPLAY_LANG.views.messages.please_select_file)
        CreateToast('PS', FUI_DISPLAY_LANG.views.messages.please_select_file, '')
        return
    }

    create_form.find(':submit').addClass('disabled')

    var formdata = new FormData

    formdata.append('user_id', DEFAULT_INI_SETTINGS.DOCIT_USER.USER_ID)
    formdata.append('user_name', DEFAULT_INI_SETTINGS.DOCIT_USER.USER_NAME)
    formdata.append('file', file_input[0].files[0])
    formdata.append('name', caption_input.val())
    formdata.append('title', caption_input.val())
    formdata.append('caption', caption_input.val())
    formdata.append('description', description_input.val())

    var res = {}

    file_input.next().removeClass('d-none')
    try 
    {
        res = await MEDIA_MODEL.create(formdata, progress =>
        {
            var percent = progress.percentComplete.toFixed(2)

            file_input.next().find('.progress-bar').css('width', percent+'%').text(percent+'%')
        })
        file_input.next().addClass('d-none')
        create_form.find(':submit').removeClass('disabled')
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(FUI_DISPLAY_LANG.views.messages.file_has_been_uploaded)
        CreateToast('PS', FUI_DISPLAY_LANG.views.messages.file_has_been_uploaded, '')
    } catch (error) 
    {
        console.log(error)
        file_input.next().addClass('d-none')
        create_form.find(':submit').removeClass('disabled')

        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(FUI_DISPLAY_LANG.views.messages.error)
        CreateToast('PS', FUI_DISPLAY_LANG.views.messages.error, '')
    }

    search_input.trigger('keyup')
    create_form[0].reset()
})
// select file
file_input.on('change', e =>
{
    if ( file_input[0].files.length == 0 ) return

    const file = file_input[0].files[0]

    caption_input.val( file.name.split('.')[0] )
})
//
deleteSelectedBTN.on('click',  e =>
{
    PromptConfirmDialog().then(async c =>
    {
        deleteSelectedBTN.addClass('disabled')
        for (let i = 0; i < getSelectedRows().length; i++) 
        {
            const id = getSelectedRows()[i]
            try 
            {
                var res = await MEDIA_MODEL.delete( id )
            } catch (error) 
            {
                CreateToast('PS', FUI_DISPLAY_LANG.views.messages.success_delete, '')
                ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(FUI_DISPLAY_LANG.views.messages.success_delete)
            }
        }
        console.log(res)
        deleteSelectedBTN.removeClass('disabled')
        CreateToast('PS', FUI_DISPLAY_LANG.views.messages.success_delete, '')
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(FUI_DISPLAY_LANG.views.messages.success_delete)
        //
        search_input.trigger('keyup')
    });
})
// tableElement
tableElement.on('click', async e =>
{
    var target = $(e.target)

    if ( target.data('role') == 'open_in_powerpoint' )
    {
        var parent = target.closest('[data-role="row"]')
        var progressBar = parent.find('.progress')
        var extension = parent.data('extension')
        var uuid = parent.data('uuid')

        var filepath = `${APP_TMP_DIR}/docs/pptx/${uuid}.${extension}`

        if ( !fs.existsSync(path.dirname(filepath)) ) fs.mkdirSync(path.dirname(filepath))

        if ( !fs.existsSync(filepath) )
        {
            progressBar.removeClass('d-none')
            parent.addClass('disabled')
            
            await downloadFile(parent.data('url'), filepath, progress =>
            {
                var percent = progress.percent.toFixed(2)

                progressBar.find('.progress-bar').css('width', percent+'%').text(percent+'%')
            })

            progressBar.addClass('d-none')
            parent.removeClass('disabled')  
        }

        openFile(filepath)
        
    }
})
// search
search_btn.on('click', e =>
{
    displayAll({
        method_type: 'search',
        searchTerm: search_input.val(),
        advanced: {
            start: date_start_input.val(),
            end: date_end_input.val(),
            user_id: DEFAULT_INI_SETTINGS.DOCIT_USER.USER_ID,
            extension: ['pptx', 'ppt'],
        }
    })
})
search_input.on('keyup', e =>
{
    displayAll({
        method_type: 'search',
        searchTerm: search_input.val(),
        advanced: {
            user_id: DEFAULT_INI_SETTINGS.DOCIT_USER.USER_ID,
            extension: ['pptx', 'ppt'],
        }
    })
})
// display all
displayAll({
    method_type: 'search',
    searchTerm: '',
    advanced: {
        user_id: DEFAULT_INI_SETTINGS.DOCIT_USER.USER_ID,
        extension: ['pptx', 'ppt'],
    }
})
async function displayAll(params)
{
    SectionLoader(tableElement)
    
    if ( params.method_type == 'search' )
    {
        try {
            var res = await MEDIA_MODEL.search(params)
            SectionLoader(tableElement, '')
        } catch (error) 
        {
            SectionLoader(tableElement, '')
            tableElement.html('')
            console.log(error)
            return
        }
    }

    var data = res.data
    var html = ''

    $.each(data, (k,v) =>
    {
        var name = v.name

        if ( name == '' ) v.caption
        if ( name == '' ) v.title

        html += `<div class="col-lg-3 col-md-6 col-sm-12" data-role="row" data-id="${v.id}" data-name="${v.name}" data-uuid="${v.uuid}" data-url="${v.url}" data-extension="${v.extension}">
                    <div class="card hover-shadow  h-100">
                        <div class="py-2 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" data-role="CHECK" value="" id="flexCheckDefault_${v.id}">
                                <label class="form-check-label" for="flexCheckDefault_${v.id}">
                                    ${FUI_DISPLAY_LANG.views.pages.global.select}
                                </label>
                            </div>
                        </div>
                        <div class="card-body no-pointer">
                            <div class="h5">${ strSnippet(name) }</div>
                            <div class="text-primary">${v.created_at}</div>
                            <div class="">
                                <div class="progress d-none">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                        </div>
                        <div class="py-2">
                            <a class="d-inline-block mx-2 text-dark" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                ${FUI_DISPLAY_LANG.views.pages.global.more}
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a href="#" class="dropdown-item" data-role="open_in_powerpoint" data-perm="open_educational_presentations">${FUI_DISPLAY_LANG.views.pages.global.open_in_powerpoint_button}</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>PAG_SEP`
    })

    new SmoothPagination(pagination, tableElement, {
        data: html.split('PAG_SEP'),
    })
}

// get selected
function getSelectedRows()
{
    var list = [];
    var items = tableElement.find('[data-role="row"]');
    for (var i = 0; i < items.length; i++) 
    {
        var parent = $(items[i])
        var check = parent.find('[data-role="CHECK"]')

        if ( check.is(':checked') )
        {
            list.push(parent.data('id'))
        }
    }

    return list;
}


})

</script>