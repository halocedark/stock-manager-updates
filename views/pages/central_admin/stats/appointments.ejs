<div class="container-fluid" id="appointmentsStatsContainer">
	<div class="wrapper">

	</div>
	<div class="mt-3">
		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>
	</div>
	<div class="app-block my-3">
        <div class="row gx-4 gy-3">
            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="form-field-01">
                    <div class="form-field-icon-holder" id="search_btn">
                        <img src="assets/img/utils/search.svg" class="form-field-icon" alt="">	
                    </div>
                    <div class="form-field-input-holder">
                        <input type="text" id="search_input" class="form-field-input" placeholder="<%= UI_DISPLAY_LANG.views.pages.global.placeholder5 %>">
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="form-field-01">
                    <div class="form-field-input-holder">
                        <div class="form-field-label"><%= UI_DISPLAY_LANG.views.pages.global.label5 %></div>
                        <input type="date" id="start_input" class="form-field-input">
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="form-field-01">
                    <div class="form-field-input-holder">
                        <div class="form-field-label"><%= UI_DISPLAY_LANG.views.pages.global.label6 %></div>
                        <input type="date" id="end_input" class="form-field-input">
                    </div>
                </div>
            </div>
        </div>
	</div>

    <div class="app-block mt-3 d-none">
        <ul class="list-group list-group-flush" id="more_details_list">
            <!-- <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li> -->
        </ul>
    </div>

    <div class="app-block mt-3">
        <div id="pagination" class="flex flex-center my-3"></div>
        <div class="table-div">
            <div class="utable odd-columns" id="table_element">
                <div class="thead">
                    <div class="td"><%= UI_DISPLAY_LANG.views.pages.global.th7 %></div>
                    <div class="td"><%= UI_DISPLAY_LANG.views.pages.global.th8 %></div>
                    <div class="td"><%= UI_DISPLAY_LANG.views.pages.global.th6 %></div>
                </div>
                <div class="tbody">
                    <!-- <div class="tr">
                        <div class="td">name</div>
                        <div class="td">phone</div>
                        <div class="td">date</div>
                    </div> -->
                </div>
            </div>
        </div>
    </div>

    <div class="app-block mt-3 d-none">
        <ul class="list-group list-group-flush" id="more_clients_details_list">
            <!-- <li class="list-group-item">An item</li>
            <li class="list-group-item">A second item</li>
            <li class="list-group-item">A third item</li>
            <li class="list-group-item">A fourth item</li>
            <li class="list-group-item">And a fifth one</li> -->
        </ul>
    </div>

    <div class="app-block mt-3 d-none" id="class_clients_list">
        <!-- <div class="table-nav">
            <input type="text" class="input-text input-text-outline" id="search_input2">
        </div> -->
        <div id="pagination2" class="flex flex-center my-3"></div>
        <div class="table-div">
            <div class="utable separate-rows" id="table_element2">
                <div class="thead">
                    <div class="td"><%= UI_DISPLAY_LANG.views.pages.global.th1 %></div>
                    <div class="td"><%= UI_DISPLAY_LANG.views.pages.global.th2 %></div>
                </div>
                <div class="tbody">
                    <!-- <div class="tr">
                        <div class="td">name</div>
                        <div class="td">phone</div>
                    </div> -->
                </div>
            </div>
        </div>
    </div>

</div>

<script>

$(function()
{

var page_container = $('#appointmentsStatsContainer')
var ERROR_BOX = page_container.find('#ERROR_BOX')

var search_btn = page_container.find('#search_btn')
var search_input = page_container.find('#search_input')
var start_input = page_container.find('#start_input')
var end_input = page_container.find('#end_input')

var more_details_list = $('#more_details_list')
var pagination = page_container.find('#pagination')
var table_element = page_container.find('#table_element')

var class_clients_list = $('#class_clients_list')
// var search_input2 = page_container.find('#search_input2')
var more_clients_details_list = $('#more_clients_details_list')
var pagination2 = page_container.find('#pagination2')
var table_element2 = page_container.find('#table_element2')

start_input.val(CURRENT_DATE)
end_input.val(CURRENT_DATE)

// table_element
table_element.on('click', e =>
{
    var target = $(e.target)

    if ( target.data('role') == 'class_name' )
    {
        var parent = target.closest('.tr')
        displayClients(parent.data('class-id'))
    }
})
// search
search_input.on('keyup', e =>
{
    displayAll()
})

// display all
displayAll()
async function displayAll()
{
    var res = await searchAppointementClassesCreatedByEmployee({
        query: search_input.val(),
        start: start_input.val(),
        end: end_input.val(),
    })
    
    if ( res.code == 404 )
        return

    var data = res.data
    var html = ''
    var total_apt = data.length
    var last_apt = data[0]

    $.each(data, (k,v) =>
    {
        if ( FUI_DISPLAY_LANG.lang == 'ar' )
        {
            html += `<div class="tr" data-class-id="${v.classId}">
                        <div class="td"><a href="#" data-role="class_name" class="pointer">${v.className}</a></div>
                        <div class="td">(${v.total_patients}) زبون</div>
                        <div class="td">${v.aptDate} | ${v.aptTime}</div>
                    </div>PAG_SEP`    
        }
        
    })
    // add html
    var options = {
        data: html.split('PAG_SEP'),
        resultsPerPage: 9
    };
    new SmoothPagination(pagination, table_element.find('.tbody'), options);
    // more details
    more_details_list.parent().removeClass('d-none')
    if ( FUI_DISPLAY_LANG.lang == 'ar' )
    {
        more_details_list.html(`
            <li class="list-group-item">اجمالي: ${total_apt} موعد</li>
            <li class="list-group-item">
                آخر موعد: ${last_apt.aptName} (${last_apt.className})
                في ${last_apt.aptDate} | ${last_apt.aptTime}
            </li>
        `)
    }
    else if ( FUI_DISPLAY_LANG.lang == 'fr' )
    {
        more_details_list.html(`
            <li class="list-group-item">Total: ${total_apt} rendez-vous</li>
            <li class="list-group-item">
                dernier rendez-vous: ${last_apt.aptName} (${last_apt.className})
                dans ${last_apt.aptDate} | ${last_apt.aptTime}
            </li>
        `)
    }
}
// display clients
async function displayClients(classId)
{
    var res = await searchAppointementClassClientsByEmployee({
        classId: classId,
        query: '',
        start: start_input.val(),
        end: end_input.val(),
    })

    if ( res.code == 404 )
        return

    var data = res.data
    var html = ''
    var total_clients = data.length
    var last_client = data[0]

    $.each(data, (k,v) =>
    {
        html += `<div class="tr">
                    <div class="td">${v.patientName}</div>
                    <div class="td">${v.patientPhone}</div>
                </div>PAG_SEP`       
    })
    // add html
    var options = {
        data: html.split('PAG_SEP'),
        resultsPerPage: 9
    };
    new SmoothPagination(pagination2, table_element2.find('.tbody'), options);
    class_clients_list.removeClass('d-none')
    // more details
    more_clients_details_list.parent().removeClass('d-none')
    if ( FUI_DISPLAY_LANG.lang == 'ar' )
    {
        more_clients_details_list.html(`
            <li class="list-group-item">اجمالي: ${total_clients} زبائن</li>
            <li class="list-group-item">
                آخر زبون: ${last_client.patientName} (${last_client.patientPhone})
            </li>
        `)
    }
    else if ( FUI_DISPLAY_LANG.lang == 'fr' )
    {
        more_clients_details_list.html(`
        <li class="list-group-item">Total: ${total_clients} clients</li>
            <li class="list-group-item">
                dernier client: ${last_client.patientName} (${last_client.patientPhone})
            </li>
        `)
    }
}

})

</script>