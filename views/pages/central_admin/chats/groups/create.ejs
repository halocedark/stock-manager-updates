<div class="container-fluid" id="create_chat_groups_container">
	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.send_message.sectionTitle %></h1>
	</div>

    <div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
        <img src="assets/img/utils/info.png" class="alert-icon" alt="">
        <div class="alert-text" id="text"></div>
    </div>
    
	<div class="mt-3">
		
        <div class="row gx-4 gy-4">

            <div class="col-lg-6 col-md-6" data-perm="create_chat_groups">

                <div class="app-block">

                    <form action="#" id="create_form">

                        <div class="mb-2">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label1 %></label>
                            <input type="text" class="input-text input-text-outline" name="name" id="name_input">
                        </div>
            
                        <div class="mb-2">
                            <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label89 %></label>
                            <textarea class="input-text input-text-outline" name="description" id="description_input" rows="4"></textarea>
                        </div>

                        <div class="row mb-2 gy-4">

                            <div class="col-lg-12 col-md-4">
                                <div class="">
                                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.select_image %></label>
                                    <input type="file" class="input-text input-text-outline js_file_input_previewable" accept="image/*" id="cover_file" data-preview-target="#chat_group_cover_preview">
                                </div>
                            </div>

                            <div class="col-lg-12 col-md-4">
                                <img src="" class="w-100 max-height-500px img-thumbnail js_image_src_placeholder" data-croppable="true" data-placeholder="../assets/img/utils/placeholder.png" alt="" id="chat_group_cover_preview">
                            </div>

                        </div>
                        
                        <div class="">
                            <input type="submit" class="btn btn-primary btn-sm" value="<%= UI_DISPLAY_LANG.views.pages.global.save_changes_button %>">
                        </div>
            
                    </form>

                </div>

            </div>

            <div class="col-lg-6 col-md-6" data-perm="view_chat_groups">

                <div class="app-block">

                    <div class="table-nav">

                        <div class="row gx-4 gy-4">
    
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <%- include(`${SETTINGS.UI_Settings.MAIN_DIR_NAME}/views/templates/searchbox.template.ejs`, {
                                    searchBtnId: 'search_btn',
                                    searchInputId: 'search_input',
                                }) -%>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <%- include(`${SETTINGS.UI_Settings.MAIN_DIR_NAME}/views/templates/start-end-date.template.ejs`, {
                                    dateStartId: 'date_start_input',
                                    dateEndId: 'date_end_input',
                                }) -%>
                            </div>
                            <div class="col-lg col-md col-sm-12">
                                <div class="fs-20 mb-2">
                                    <span class="fw-700"><%= UI_DISPLAY_LANG.views.pages.global.text22 %>:</span> <span class="text-success" id="groups_total">0</span>
                                </div>
                                <ul class="list-group list-group-flush" id="groups_extra_data_list">
                                    <!-- <li class="list-group-item">An item</li> -->
                                </ul>
                            </div> 
    
                        </div>
    
                    </div>

                </div>

            </div>

            <div class="col-lg col-md" data-perm="view_chat_groups">

                <div class="app-block">

                    <div id="pagination" class="flex flex-center"></div>

                    <div class="utable shadowed" id="table_element">
                        <div class="thead">
                            <div class="td">#</div>
                            <div class="td"><%= UI_DISPLAY_LANG.views.pages.global.th1 %></div>
                            <div class="td"><%= UI_DISPLAY_LANG.views.pages.global.th52 %></div>
                            <div class="td"></div>
                        </div>
                        <div class="tbody">
                            <!--
                            <div class="tr" data-role="row" data-id="">
                                <div class="td">
                                    <input type="checkbox" class="form-check-input pointer" data-role="CHECK">
                                </div>
                                <div class="td">name</div>
                                <div class="td">body</div>
                                <div class="td">
                                    <button class="btn btn-primary btn-sm pointer" data-role="UPDATE" data-aptid="">
                                        <span class="no-pointer"><i class="fas fa-edit"></i></span>
                                    </button>		
                                </div>
                            </div>
                            -->
                        </div>
                    </div>

                </div>

            </div>

        </div>

	</div>
</div>

<script>

$(function()
{

var page_container = $('#create_chat_groups_container')

if ( page_container[0] == undefined ) return

var ERROR_BOX = page_container.find('#ERROR_BOX')

var create_form = page_container.find('#create_form')
var name_input = create_form.find('#name_input')
var description_input = create_form.find('#description_input')
var chat_group_cover_preview = create_form.find('#chat_group_cover_preview')

var pagination = page_container.find('#pagination')
var table_element = page_container.find('#table_element')

var search_input = page_container.find('#search_input')
var search_btn = page_container.find('#search_btn')
var date_start_input = page_container.find('#date_start_input')
var date_end_input = page_container.find('#date_end_input')

var groups_total = page_container.find('#groups_total')
var groups_extra_data_list = page_container.find('#groups_extra_data_list')

date_start_input.val(CURRENT_DATE)
date_end_input.val(CURRENT_DATE)

var ChatObject = {}

create_form.on('submit', async e =>
{
    e.preventDefault()
    var target = create_form

    ChatObject.name = name_input.val()
    ChatObject.description = description_input.val()
    ChatObject.cover = chat_group_cover_preview.attr('src')

    SectionLoader(create_form)
    // update
    if ( ChatObject.id )
    {
        var res = await CHAT_MODEL.group_update(ChatObject)
        SectionLoader(create_form, '')
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)

        if ( res.code == 404 ) return

        target[0].reset()
        ChatObject.id = null
        displayAll({
            method_type: 'group_search',
            query: search_input.val(),
        })
        return
    }
    // store
    var res = await CHAT_MODEL.group_store(ChatObject)
    SectionLoader(create_form, '')
    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)

    if ( res.code == 404 ) return

    target[0].reset()

    displayAll({
        method_type: 'group_search',
        query: search_input.val(),
    })
})
// table_element
table_element.on('click', async e =>
{
    var target = $(e.target)

    if ( target.data('role') == 'UPDATE' )
    {
        var parent = target.closest('[data-role="row"]')
        
        parent.addClass('disabled')
        var res = await CHAT_MODEL.group_show({
            id: parent.data('id')
        })
        parent.removeClass('disabled')
        if ( res.code == 404 ) return

        ChatObject = res.data
        displayInfo()
    }
    else if ( target.data('role') == 'ENTER' )
    {
        var parent = target.closest('[data-role="row"]')
        
        parent.addClass('disabled')
        var res = await CHAT_MODEL.group_show({
            id: parent.data('id')
        })
        parent.removeClass('disabled')
        if ( res.code == 404 ) return

        ChatObject = res.data
        goToPage('show-chat-group', ChatObject)
    }
})
// search
search_btn.on('click', e =>
{
    displayAll({
        method_type: 'group_search',
        query: search_input.val(),
        advanced: {
            start: date_start_input.val(),
            end: date_end_input.val(),
        }
    })
})
search_input.on('keyup', e =>
{
    displayAll({
        method_type: 'group_search',
        query: search_input.val(),
    })
})
// display all
displayAll({
    method_type: 'group_search',
    query: search_input.val(),
})
async function displayAll(params)
{
    // total
    groups_total.text(0)

    groups_extra_data_list.html('')
    table_element.find('.tbody').html('')
    if ( params.method_type == 'group_search' )
        var res = await CHAT_MODEL.group_search(params)

    if ( res.code == 404 ) return

    var data = res.data
    var html = ''
    var last_data = firstArrayElement(data)
    // total
    groups_total.text(data.length)
    $.each(data, (k,v) =>
    {
        html += `<div class="tr" data-role="row" data-id="${v.id}">
                        <div class="td">
                            <input type="checkbox" class="form-check-input pointer" data-role="CHECK">
                        </div>
                        <div class="td">${ strSnippet(v.name) }</div>
                        <div class="td">${ strSnippet(v.description, 120) }</div>
                        <div class="td pointer overflow-visible">
                            <div class="mb-2">
                                ${v.created_at}    
                            </div>
                            <div class="dropdown">
                                <a href="#" class="dropdown-toggle" type="button" id="dropdownMenuButton_${v.id}" data-bs-toggle="dropdown" aria-expanded="false">
                                    ${FUI_DISPLAY_LANG.views.pages.global.label30}
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton_${v.id}">
                                    <li><a class="dropdown-item" href="#" data-role="UPDATE" data-perm="update_chat_groups">${FUI_DISPLAY_LANG.views.pages.global.actions.update}</a></li>
                                    <li><a class="dropdown-item" href="#" data-role="ENTER" data-perm="enter_chat_groups">${FUI_DISPLAY_LANG.views.pages.global.actions.enter}</a></li>
                                </ul>
                            </div>		
                        </div>
                    </div>PAG_SEP`
    })

    new SmoothPagination(pagination, table_element.find('.tbody'), {
        data: html.split('PAG_SEP')
    })
    // extra data
    groups_extra_data_list.html(`
        <li class="list-group-item">
            <span class="fw-500">${ FUI_DISPLAY_LANG.views.pages.global.text36 }: </span>
            <span>${FUI_DISPLAY_LANG.views.pages.global.for_} </span>
            <span>${last_data.name}</span>, 
            <span class="text-primary">${last_data.created_at}</span> 
        </li>
        <li class="list-group-item">
            <span class="fw-500">${ FUI_DISPLAY_LANG.views.pages.global.text39 }: </span>
            <span>${ (last_data.description) ?? '' } </span>
        </li>
    `)
}
// show
displayInfo()
function displayInfo()
{
    if ( !ChatObject.id ) return
    
    fillForm(create_form, ChatObject)

    chat_group_cover_preview.attr('src', imgFallback(ChatObject.cover))
}

})

</script>