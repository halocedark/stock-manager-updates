<div class="container-fluid" id="addAppointementsContainer">
	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.add_appointement.sectionTitle %></h1>
	</div>
	<div class="mt-3 app-block">
		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>
		<div class="" id="wrapper01">
			<form action="#" id="addForm">
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_appointement.form01.label01 %></label>
					<select name="" class="input-text" id="classSelect">
						
					</select>
				</div>
				<div class="mb-2">
					<ul class="list-h tabs-list">
						<li class="list-item list-item-solid flex flex-center active" data-role="TAB" data-tab="#select_patient_wrapper">
							<%= UI_DISPLAY_LANG.views.pages.add_appointement.text01 %>
						</li>
						<li class="list-item list-item-solid flex flex-center" data-role="TAB" data-tab="#add_patient_wrapper">
							<%= UI_DISPLAY_LANG.views.pages.add_appointement.text02 %>
						</li>
					</ul>
					<div>

						<div id="select_patient_wrapper">
							<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_appointement.form01.label02 %></label>
							<input type="text" class="input-text input-text-outline border-0 mb-1" id="patientsSearchInput" placeholder="<%= UI_DISPLAY_LANG.views.pages.add_appointement.form01.ph01 %>">
							<select name="" class="input-text" id="patientSelect">
								
							</select>
						</div>
						<div id="add_patient_wrapper" class="d-none">

								<div class="mb-2">
									<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_patients.form01.label01 %></label>
									<input type="text" class="input-text" id="patientName_input">
								</div>
								<div class="mb-2">
									<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_patients.form01.label02 %></label>
									<input type="text" class="input-text" id="patientPhone_input">
								</div>
								<div class="d-none">
									<button type="button" class="btn btn-primary btn-sm" id="addPatientBTN">
										<%= UI_DISPLAY_LANG.views.pages.add_patients.form01.submitBTN01 %>
									</button>
								</div>

						</div>

					</div>
				</div>
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_appointement.form01.label09 %></label>
					<input type="text" class="input-text input-text-outline" id="aptNameInput">
				</div>
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_appointement.form01.label08 %></label>
					<input type="number" step="any" class="input-text input-text-outline" id="aptPriceInput">
				</div>
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_appointement.form01.label03 %></label>
					<textarea class="input-text input-text-outline" rows="4" id="aptNoteInput"></textarea>
				</div>
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_appointement.form01.label04 %></label>
					<input type="date" class="input-text input-text-outline" id="aptDateInput">
				</div>
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_appointement.form01.label05 %></label>
					<input type="time" step="any" class="input-text input-text-outline" id="aptTimeInput">
				</div>
				<div class="">
					<input type="submit" class="btn btn-primary btn-sm" value="<%= UI_DISPLAY_LANG.views.pages.add_appointement.form01.submitBTN01 %>">
				</div>
			</form>
		</div>
	</div>
</div>

<script>

$(function()
{

var addAppointementsContainer = $('#addAppointementsContainer');

var ERROR_BOX = addAppointementsContainer.find('#ERROR_BOX');
var addForm = addAppointementsContainer.find('#addForm');
var classSelect = addForm.find('#classSelect');
var patientsSearchInput = addForm.find('#patientsSearchInput');
var patientSelect = addForm.find('#patientSelect');
var aptNoteInput = addForm.find('#aptNoteInput');
var aptDateInput = addForm.find('#aptDateInput');
var aptTimeInput = addForm.find('#aptTimeInput');
var aptNameInput = addForm.find('#aptNameInput');
var aptPriceInput = addForm.find('#aptPriceInput');

var wrapper01 = addAppointementsContainer.find('#wrapper01');

var tabs_list = $('.tabs-list');

var addPatientBTN = $('#addPatientBTN');

var promise02 = null;
var promise03 = null;
// set default date / time
var now = new Date();
aptDateInput.val( date_time.format(now, 'YYYY-MM-DD') );
aptTimeInput.val( date_time.format(now, 'HH:mm:ss') );
var AppointementObject = {
    aptId: sessionData().aptId,
    clinicId: sessionData().clinicId,
    classId: sessionData().classId,
    patientId: sessionData().patientId,
    patientName: sessionData().patientName,
    aptNote: null,
    aptDate: null,
    aptTime: null,
    type: 'private',
}
// clear session
sessionData(true)
// addPatientForm
addPatientBTN.off('click');
addPatientBTN.on('click', async e =>
{
    e.preventDefault();
    // var target = addPatientBTN.parent().parent();
    // // console.log(target.find('#patientName_input').val());
    // var PatientObject = {
    //     patientId: null,
    // };
    // PatientObject.clinicId = USER_CONFIG.administration.clinicId;
    // PatientObject.patientHashId = uniqid();
    // PatientObject.patientCode = '';
    // PatientObject.patientName = $('#patientName_input').val();
    // PatientObject.patientPhone = $('#patientPhone_input').val();
    // PatientObject.patientPass = '';
    // PatientObject.patientAge = '';
    // PatientObject.patientGender = '';
    // PatientObject.patientAddress = '';
    // PatientObject.patientState = '';
    // PatientObject.patientWhatsapp = '';
    // PatientObject.patientFB = '';
    // PatientObject.patientTelegram = '';
    // PatientObject.patientChildren = '';
    // PatientObject.patientBirthPlace = '';
    // PatientObject.patientBirthDate = '';
    // PatientObject.hasDiabetes = '';
    // PatientObject.hasBloodPressure = '';
    // PatientObject.hasChronicDisease = '';

    // PatientObject.patientJob = '';
    // PatientObject.studyLevel = '';
    // PatientObject.patientGroup = '';
    // PatientObject.height = '';
    // PatientObject.weight = '';
    // PatientObject.best_weight = '';
    // PatientObject.signup_reason = '';
    // PatientObject.title = '';

    // SectionLoader(target);
    // //create qr code
    // var page = `${PROJECT_URL}Patient/Dashboard/?patient_session=${PatientObject.patientHashId}`;
    // var qrcode = await generateQRCode( page );
    // PatientObject.patientQRCode = qrcode;
    // var response = await PATIENT_MODEL.store(PatientObject);
    // SectionLoader(target, '');
    // if ( response.code == 404 )
    // {
    //     ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
    //     return;
    // }
    
    // AppointementObject.patientId = response.data.patientId;
    // patientsSearchInput.trigger('keyup');
});
// switch tabs
tabs_list.off('click');
tabs_list.on('click', e =>
{
    var target = $(e.target);
    if ( target.data('role') == 'TAB' )
    {
        var tab = $(target.data('tab'));
        tab.removeClass('d-none').siblings().addClass('d-none');
        target.addClass('active').siblings().removeClass('active');
    }
});
// addForm submit
addForm.off('submit');
addForm.on('submit', async e =>
{
    e.preventDefault();
    var target = addForm;
    var add_patient_wrapper = addPatientBTN.parent().parent()
    if ( !add_patient_wrapper.hasClass('d-none')
        && $('#patientName_input').val() != ''
        && $('#patientPhone_input').val() != ''
        && AppointementObject.aptId == null )
    {
        // console.log(target.find('#patientName_input').val());
        var PatientObject = {
            patientId: null,
        };
        PatientObject.clinicId = USER_CONFIG.administration.clinicId;
        PatientObject.clinicName = USER_CONFIG.administration.clinicName;
        PatientObject.patientHashId = uniqid();
        PatientObject.patientCode = '';
        PatientObject.patientName = $('#patientName_input').val();
        PatientObject.patientPhone = $('#patientPhone_input').val();
        PatientObject.patientPass = '';
        PatientObject.patientAge = '';
        PatientObject.patientGender = '';
        PatientObject.patientAddress = '';
        PatientObject.patientState = '';
        PatientObject.patientWhatsapp = '';
        PatientObject.patientFB = '';
        PatientObject.patientTelegram = '';
        PatientObject.patientChildren = '';
        PatientObject.patientBirthPlace = '';
        PatientObject.patientBirthDate = '';
        PatientObject.hasDiabetes = '';
        PatientObject.hasBloodPressure = '';
        PatientObject.hasChronicDisease = '';

        PatientObject.patientJob = '';
        PatientObject.studyLevel = '';
        PatientObject.patientGroup = '';
        PatientObject.height = '';
        PatientObject.weight = '';
        PatientObject.best_weight = '';
        PatientObject.signup_reason = '';
        PatientObject.title = '';

        SectionLoader(add_patient_wrapper);
        //create qr code
        var page = `${PROJECT_URL}Patient/Dashboard/?patient_session=${PatientObject.patientHashId}`;
        var qrcode = await generateQRCode( page );
        PatientObject.patientQRCode = qrcode;
        var response = await PATIENT_MODEL.store(PatientObject);
        SectionLoader(add_patient_wrapper, '');
        if ( response.code == 404 )
        {
            ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
            return;
        }
        
        AppointementObject.patientId = response.data.patientId
        patientSelect.html(`<option value="${response.data.patientId}">${response.data.patientName}</option>`)
        setOptionSelected( patientSelect, AppointementObject.patientId )
        // patientsSearchInput.trigger('keyup');
    }

    AppointementObject.clinicId = USER_CONFIG.administration.clinicId
    AppointementObject.clinicName = USER_CONFIG.administration.clinicName
    AppointementObject.classId = classSelect.find(':selected').val();
    AppointementObject.className = classSelect.find(':selected').text();
    AppointementObject.patientId = patientSelect.find(':selected').val();
    AppointementObject.aptNote = aptNoteInput.val();
    AppointementObject.aptDate = aptDateInput.val();
    AppointementObject.aptTime = aptTimeInput.val();
    AppointementObject.aptName = aptNameInput.val();
    AppointementObject.aptPrice = aptPriceInput.val();
    AppointementObject.attendance = ST_YES
    AppointementObject.isPaid = ST_NO;

    // display loader
    SectionLoader(wrapper01);
    // update
    if ( AppointementObject.aptId != null )
    {
        APPOINTMENT_MODEL.update(AppointementObject).then(response =>
        {
            // hide loader
            SectionLoader(wrapper01, '');
            if ( response.code == 404 )
            {
                ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
                return;
            }
            ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
            // reset
            target[0].reset();
            aptDateInput.val( date_time.format(now, 'YYYY-MM-DD') );
            aptTimeInput.val( date_time.format(now, 'HH:mm:ss') );
            //
            AppointementObject.aptId = null;
        });
        return;
    }
    // add
    APPOINTMENT_MODEL.store(AppointementObject).then(response =>
    {
        // hide loader
        SectionLoader(wrapper01, '');
        if ( response.code == 404 )
        {
            ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
            return;
        }
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
        // reset
        target[0].reset();
        aptDateInput.val( date_time.format(now, 'YYYY-MM-DD') );
        aptTimeInput.val( date_time.format(now, 'HH:mm:ss') );
    })
});
// search patients
patientsSearchInput.off('keyup');
patientsSearchInput.on('keyup', e =>
{
    var val = patientsSearchInput.val();
    var SearchObject = {
        clinicId: USER_CONFIG.administration.clinicId,
        query: val
    };
    // display loader
    if ( FUI_DISPLAY_LANG.lang == 'ar' )
        TopLoader("جاري البحث...");
    else if ( FUI_DISPLAY_LANG.lang == 'fr' )
        TopLoader("En train de rechercher...");

    promise02 = PATIENT_MODEL.searchLocal(SearchObject);
    promise02.then(response =>
    {
        // hide loader
        TopLoader('', false);
        if ( response.code == 404 )
            return;

        var data = response.data;
        var html = '';
        $.each(data, (k,v) =>
        {
            html += `<option value="${v.patientId}">${v.patientName}</option>`;
        });
        // add html
        patientSelect.html(html);
        if ( AppointementObject.patientId != null )
            setOptionSelected( patientSelect, AppointementObject.patientId );

        AppointementObject.patientId = null;
    });
});
patientsSearchInput.trigger('keyup');
// list clinic treatment classes
var clinicId = USER_CONFIG.administration.clinicId;
// display loader
if ( FUI_DISPLAY_LANG.lang == 'ar' )
    TopLoader("جاري البحث...");
else if ( FUI_DISPLAY_LANG.lang == 'fr' )
    TopLoader("En train de rechercher...");

promise03 = TREATMENT_CLASS_MODEL.local_index({
    clinicId: clinicId
});
promise03.then(response =>
{
    // hide loader
    TopLoader('', false);
    // clear html
    classSelect.html('');
    if ( response.code == 404 )
        return;

    var data = response.data;
    var html = '';
    if ( FUI_DISPLAY_LANG.lang == 'ar' )
        classSelect.html(`<option value="" selected>حدد قسم العلاج</option>`);
    else if ( FUI_DISPLAY_LANG.lang == 'fr' )
        classSelect.html(`<option value="" selected>Sélectionnez la section de traitement</option>`);
    $.each(data, (k,v) =>
    {
        html += `<option value="${v.classId}" data-price="${v.classPrice}">${v.className}</option>`;
    });
    // add html
    classSelect.append(html);
});
// select class
classSelect.off('change');
classSelect.on('change', e =>
{
    var price = parseFloat(classSelect.find(':selected').data('price'));
    aptPriceInput.val(price.toFixed(2));
    if ( FUI_DISPLAY_LANG.lang == 'ar' )
        aptNameInput.val('موعد '+classSelect.find(':selected').text());
    else if ( FUI_DISPLAY_LANG.lang == 'fr' )
        aptNameInput.val('Rendez-vous de '+classSelect.find(':selected').text());
});
// display one
displayOne();
async function displayOne()
{
    await Promise.allSettled([promise02, promise03]);
    if ( AppointementObject.aptId == null ) return;

    setOptionSelected(classSelect, AppointementObject.classId, true);
    setOptionSelected(patientSelect, AppointementObject.patientId);
    // setOptionSelected(clinicSelect, AppointementObject.clinicId);
    // display loader
    SectionLoader(wrapper01);

    APPOINTMENT_MODEL.show({
        aptId: AppointementObject.aptId
    }).then(response =>
    {
        // hide loader
        SectionLoader(wrapper01, '');
        if ( response.code == 404 )
            return;

        var data = response.data;

        setOptionSelected(classSelect, data.classId);
        setOptionSelected(patientSelect, data.patientId);
        aptNoteInput.val( data.aptNote );
        aptDateInput.val( data.aptDate );
        aptTimeInput.val( data.aptTime );
        aptNameInput.val(data.aptName);
        aptPriceInput.val(data.aptPrice);
    });	
}


})

</script>