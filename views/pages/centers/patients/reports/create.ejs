<div class="container-fluid" id="create_patient_reports_container">

	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.all_clinics.sectionTitle %></h1>
	</div>

	<div class="alert alert-info mt-3 mb-2" style="display:none;" id="ERROR_BOX">
		<img src="assets/img/utils/info.png" class="alert-icon" alt="">
		<div class="alert-text" id="text"></div>
	</div>

	<div class="mt-3 app-block">

        <form action="" id="create_form">

            <div class="mb-2">
                <%- include(`${SETTINGS.UI_Settings.MAIN_DIR_NAME}/views/templates/select-center-clients.template.ejs`, {
                    selectId: 'client_select',
                }) -%>
            </div>

            <div class="mb-2">
                <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label4 %></label>
				<textarea name="body" class="input-text input-text-outline" id="body_input" rows="4"></textarea>
            </div>

            <div class="mb-2">
                <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.select_date %></label>
				<input type="date" name="date" class="input-text input-text-outline" id="date_input">
            </div>

            <div class="mb-2">
                <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.select_time %></label>
				<input type="time" name="time" step="any" class="input-text input-text-outline" id="time_input">
            </div>

            <div class="">
                <input type="submit" class="btn btn-primary btn-sm" value="<%= UI_DISPLAY_LANG.views.pages.global.save_changes_button %>">
            </div>

        </form>
        
	</div>

</div>

<script>

$(function()
{

var page_container = $('#create_patient_reports_container')

if ( !page_container[0] ) return

var ERROR_BOX = page_container.find('#ERROR_BOX')

var create_form = page_container.find('#create_form')
var client_select = page_container.find('#client_select')
var body_input = page_container.find('#body_input')
var date_input = page_container.find('#date_input')
var time_input = page_container.find('#time_input')

//
date_input.val(CURRENT_DATE)

var ReportObject = sessionData(true)
// submit
create_form.on('submit', async e =>
{
    e.preventDefault()
    
    create_form.find(':submit').addClass('disabled')

    const PatientData = checkJSON( decodeURIComponent( atob( client_select.find(':selected').data('object') ) ) )

    ReportObject.clinicId = USER_CONFIG.administration.clinicId
    ReportObject.clinicName = USER_CONFIG.administration.clinicName
    ReportObject.patientId = client_select.find(':selected').val()
    ReportObject.patientName = client_select.find(':selected').text()
    ReportObject.patientPhone = PatientData.patientPhone
    ReportObject.body = body_input.val()
    ReportObject.date = date_input.val()
    ReportObject.time = time_input.val()
    // update
    if ( ReportObject.id )
    {

        var res = await PATIENT_MODEL.report_update(ReportObject)

        create_form.find(':submit').removeClass('disabled')
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
        CreateToast('PS', res.message, '')

        if ( res.code == 404 ) return

        create_form.find('textarea').val(null)
        ReportObject.id = null

        return
    }

    // create
    var res = await PATIENT_MODEL.report_store(ReportObject)

    create_form.find(':submit').removeClass('disabled')
    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(res.message)
    CreateToast('PS', res.message, '')

    if ( res.code == 404 ) return

    create_form.find('textarea').val(null)
})

// center-client-selected
$(document).off('center-client-selected').on('center-client-selected', e =>
{
    var detail = e.originalEvent.detail
    
    if ( Object.keys(ReportObject).length == 0 ) return

    setOptionSelected(client_select, ReportObject.patientId)
})
// show
displayOne()
function displayOne()
{
    if ( !ReportObject.id ) return

    fillForm(create_form[0], ReportObject)
    
    // center-client-selected
    $(document).off('center-client-selected').on('center-client-selected', e =>
    {
        var detail = e.originalEvent.detail
 
        setOptionSelected(client_select, ReportObject.patientId)
    })
}

})

</script>