<div class="container-fluid" id="sendMessageContainer">
	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.send_message.sectionTitle %></h1>
	</div>
	<div class="mt-3 app-block">
		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>
		<div class="WRAPPER d-none" id="sendToPatientsWrapper">
			<form action="#" id="sendMSGForm">
				<div class="mb-2">
                    <%- include(SETTINGS.UI_Settings.MAIN_DIR_NAME+'views/templates/select-center-clients.template.ejs', {
                        componentId: 'center_clients_component',
                        selectId: 'receiverSelect',
                        eventsReceiverId: 'online_followup_appointments_container',
                    }) -%>
				</div>
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.send_message.form01.label02 %></label>
					<input type="text" class="input-text input-text-outline" id="subjectInput" placeholder="<%= UI_DISPLAY_LANG.views.pages.send_message.form01.ph01 %>">
				</div>
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label4 %></label>
					<textarea class="input-text input-text-outline" rows="5" id="bodyInput" placeholder="<%= UI_DISPLAY_LANG.views.pages.send_message.form01.ph02 %>"></textarea>
				</div>
                <div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.select_file %></label>
					<input type="file" class="input-text input-text-outline" id="attachmentsInput" multiple>
				</div>
				<div class="">
					<input type="submit" class="btn btn-primary btn-sm" value="<%= UI_DISPLAY_LANG.views.pages.send_message.form01.submitBTN01 %>">
					<a href="#" class="text-02 d-inline-block mx-2" id="switchToEmployeeMessagingBTN">
						<%= UI_DISPLAY_LANG.views.pages.send_message.link01 %>
					</a>
				</div>
			</form>
		</div>
		<div class="WRAPPER" id="sendToEmployeeWrapper">
			<form action="#" id="sendMSGToEmployeeForm">
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.send_message.form01.label05 %></label>
					<input type="text" class="input-text input-text-outline" id="employeePhoneInput">
				</div>
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.send_message.form01.label02 %></label>
					<input type="text" class="input-text input-text-outline" id="subject2Input" placeholder="<%= UI_DISPLAY_LANG.views.pages.send_message.form01.ph01 %>">
				</div>
				<div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label4 %></label>
					<textarea class="input-text input-text-outline" rows="5" id="body2Input" placeholder="<%= UI_DISPLAY_LANG.views.pages.send_message.form01.ph02 %>"></textarea>
				</div>
                <div class="mb-2">
					<label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.select_file %></label>
					<input type="file" class="input-text input-text-outline" id="attachmentsInput2" multiple>
				</div>
				<div class="">
					<input type="submit" class="btn btn-primary btn-sm" value="<%= UI_DISPLAY_LANG.views.pages.send_message.form01.submitBTN01 %>">
					<a href="#" class="text-02 d-inline-block mx-2" id="switchBackToPatientsMessagingBTN">
						<%= UI_DISPLAY_LANG.views.pages.send_message.link02 %>
					</a>
				</div>
			</form>
		</div>

	</div>
</div>

<script>

$(function()
{

var sendMessageContainer = $('#sendMessageContainer');
if ( sendMessageContainer[0] == undefined )
    return;

var ERROR_BOX = sendMessageContainer.find('#ERROR_BOX');
var sendMSGForm = sendMessageContainer.find('#sendMSGForm');
var searchPatientsInput = sendMessageContainer.find('#searchPatientsInput');
var receiverSelect = sendMessageContainer.find('#receiverSelect');
var subjectInput = sendMessageContainer.find('#subjectInput');
var bodyInput = sendMessageContainer.find('#bodyInput');
var attachmentsInput = sendMessageContainer.find('#attachmentsInput');


var sendToPatientsWrapper = sendMessageContainer.find('#sendToPatientsWrapper');
var switchToEmployeeMessagingBTN = sendToPatientsWrapper.find('#switchToEmployeeMessagingBTN');
var sendToEmployeeWrapper = sendMessageContainer.find('#sendToEmployeeWrapper');
var switchBackToPatientsMessagingBTN = sendToEmployeeWrapper.find('#switchBackToPatientsMessagingBTN');

var sendMSGToEmployeeForm = sendMessageContainer.find('#sendMSGToEmployeeForm');
var employeePhoneInput = sendMessageContainer.find('#employeePhoneInput');
var subject2Input = sendMessageContainer.find('#subject2Input');
var body2Input = sendMessageContainer.find('#body2Input');
var attachmentsInput2 = sendMessageContainer.find('#attachmentsInput2');

// back to patients messaging
switchBackToPatientsMessagingBTN.off('click');
switchBackToPatientsMessagingBTN.on('click', e =>
{
    sendToPatientsWrapper.slideDown(200).siblings('.WRAPPER').slideUp(200);
});
// back to manager messaging
switchToEmployeeMessagingBTN.off('click');
switchToEmployeeMessagingBTN.on('click', e =>
{
    sendToEmployeeWrapper.slideDown(200).siblings('.WRAPPER').slideUp(200);
});
// send
sendMSGForm.off('submit');
sendMSGForm.on('submit', async e =>
{
    e.preventDefault();
    var target = sendMSGForm;
    var MessageObject = {
        sender: USER_CONFIG.administration.clinicHash,
        receiver: receiverSelect.find(':selected').val(),
        subject: subjectInput.val(),
        body: bodyInput.val()
    };
    if ( attachmentsInput[0].files.length > 0 ) MessageObject.attachments = attachmentsInput[0].files
    // display loader
    if ( FUI_DISPLAY_LANG.lang == 'ar' )
        TopLoader("يتم ارسال الرسالة...");
    else if ( FUI_DISPLAY_LANG.lang == 'fr' )
        TopLoader("Le message est envoyé...");

    var response = await MESSAGE_MODEL.send(MessageObject)
    
    // hide loader
    TopLoader('', false);
    if ( response.code == 404 )
    {
        ERROR_BOX.show(0).delay(7*1000).hide(0)
        .find('#text').text(response.message);
        return;
    }
    ERROR_BOX.show(0).delay(7*1000).hide(0)
    .find('#text').text(response.message);
    // reset
    target[0].reset();
    
});
// send to manager
sendMSGToEmployeeForm.off('submit');
sendMSGToEmployeeForm.on('submit', async e =>
{
    e.preventDefault();
    var target = sendMSGToEmployeeForm;

    //display loader
    if ( FUI_DISPLAY_LANG.lang == 'ar' )
        TopLoader("جاري استرجاع الرمز التسلسلي للمستلم...");
    else if ( FUI_DISPLAY_LANG.lang == 'fr' )
        TopLoader("Récupérer le code de série du destinataire...");

    var response = await getEmployee( '', $.trim(employeePhoneInput.val()) );
    // hide loader
    TopLoader("", false);
    if ( response.code == 404 )
    {
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
        return;
    }

    var MessageObject = {
        sender: USER_CONFIG.employee_hash,
        receiver: response.data.employee_hash,
        subject: subject2Input.val(),
        body: body2Input.val()
    };
    if ( attachmentsInput2[0].files.length > 0 ) MessageObject.attachments = attachmentsInput2[0].files
    // display loader
    if ( FUI_DISPLAY_LANG.lang == 'ar' )
        TopLoader("يتم ارسال الرسالة...");
    else if ( FUI_DISPLAY_LANG.lang == 'fr' )
        TopLoader("Le message est envoyé...");

    var response = await MESSAGE_MODEL.send(MessageObject)
    
    // hide loader
    TopLoader('', false);
    if ( response.code == 404 )
    {
        ERROR_BOX.show(0).delay(7*1000).hide(0)
        .find('#text').text(response.message);
        return;
    }
    ERROR_BOX.show(0).delay(7*1000).hide(0)
    .find('#text').text(response.message);
    // reset
    target[0].reset();
    
});
// employeePhoneInput
employeePhoneInput.off('dblclick');
employeePhoneInput.on('dblclick', e =>
{
    SelectEmployeeDialog(data =>
    {
        employeePhoneInput.val(data.employee_phone);
    });
});

})

</script>