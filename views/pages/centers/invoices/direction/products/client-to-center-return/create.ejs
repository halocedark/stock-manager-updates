<div class="container-fluid" id="create_client_to_center_products_return_invoices_container">
	<div class="wrapper d-none">
		<h1 class="title-medium"><%= UI_DISPLAY_LANG.views.pages.add_products.sectionTitle %></h1>
	</div>
	<div class="mt-3 app-block">
		<div class="alert alert-info my-2" style="display:none;" id="ERROR_BOX">
			<img src="assets/img/utils/info.png" class="alert-icon" alt="">
			<div class="alert-text" id="text"></div>
		</div>
		<div id="wrapper01">
			<form action="#" id="create_form">
				<div class="mb-2">
					<%- include(`${SETTINGS.UI_Settings.MAIN_DIR_NAME}/views/templates/select-center-clients.template.ejs`, {
                        eventsReceiverId: 'create_client_to_center_products_return_invoices_container',
                        selectId: 'client_select',
                    }) -%>
				</div>

                <div class="mb-2 max-width-340px">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label38 %></label>
                    <!-- <input type="text" class="input-text" id="code_input" value=""> -->
                    <%- include(`${SETTINGS.UI_Settings.MAIN_DIR_NAME}/views/templates/select-suggestions-box.template.ejs`, {
                        componentId: '1',
                        eventsReceiverId: 'create_client_to_center_products_return_invoices_container',
                        searchInputId: 'code_input',
                        suggestions: {
                            api: {
                                model: "PRODUCT_MODEL",
                                method: "center_local_search",
                            },
                            selections: {
                                name: 'productName',
                                value: 'productCode',
                            }
                        }
                    }) -%>
                </div>

                <input type="hidden" id="idInput">
				
                <div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_products.form01.label01 %></label>
                    <input type="text" class="input-text" id="nameInput" readonly value="">
                </div>

				<div class="mb-2 d-none">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_products.form01.label02 %></label>
					<textarea name="" id="descInput" class="input-text" readonly rows="4"></textarea>
                </div>

				<div class="mb-2 d-none">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label40 %></label>
                    <input type="number" step="any" min="0" class="input-text" readonly id="buypriceInput" value="0">
                </div>

                <div class="mb-2 d-none">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label41 %></label>
                    <input type="number" step="any" min="0" class="input-text" readonly id="priceInput" value="0">
                </div>

                <div class="mb-2 d-none">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label44 %></label>
                    <input type="number" step="any" min="0" class="input-text" readonly id="wholesalePriceInput" value="0">
                </div>

                <div class="mb-2 d-none">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label45 %></label>
                    <input type="number" step="any" min="0" class="input-text" readonly id="halfWholesalePriceInput" value="0">
                </div>

                <div class="mb-2">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_products.form01.label04 %></label>
                    <input type="number" step="any" min="0" class="input-text" id="quantityInput" value="1">
                </div>

				<div class="mb-2 d-none">
                    <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.add_products.form01.label06 %></label>
                    <input type="text" step="any" min="1" class="input-text" readonly id="barcode_input" value="">
                </div> 

				<div class="my-3">
                    <div class="mb-2">
                        <button type="button" class="btn btn-success" id="addToListBTN">
                            <%= UI_DISPLAY_LANG.views.pages.add_products.btn01 %>
                        </button>
                    </div>

                    <div class="mb-2">
                        <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label92 %></label>
                        <input type="number" step="any" class="input-text" id="dept_amount_input" value="">
                    </div>
    
                    <div class="mb-2">
                        <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label42 %></label>
                        <input type="number" step="any" class="input-text" id="paid_amount_input" value="">
                    </div>

                    <div class="mb-2">
                        <label for="" class="form-label"><%= UI_DISPLAY_LANG.views.pages.global.label43 %></label>
                        <input type="number" step="any" min="1" class="input-text" readonly id="totalAmountInput" value="0">
                    </div>

                    <div class="" style="max-height: 500px;overflow-y: auto;overflow-x: hidden;">
                        <table class="table table-stripped table-hover" id="productsTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th><%= UI_DISPLAY_LANG.views.pages.global.th24 %></th>
                                    <th><%= UI_DISPLAY_LANG.views.pages.add_products.th01 %></th>
                                    <th><%= UI_DISPLAY_LANG.views.pages.add_products.th02 %></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- <tr>
                                    <td>
                                        <button class="btn-close"></button>
                                    </td>
                                    <td>name</td>
									<td>desc</td>
									<td>codebar</td>
                                    <td>quantity</td>
                                    <td>price</td>
                                </tr> -->
                            </tbody>
                        </table>
                    </div>
				</div>

				<div class="mt-2">
					<input type="submit" class="btn btn-primary btn-sm shadow" value="<%= UI_DISPLAY_LANG.views.pages.add_products.form01.submitBTN01 %>">
				</div>
			</form>	
		</div>
	</div>
</div>

<script>

$(async function()
{

var page_container = $('#create_client_to_center_products_return_invoices_container');
if ( !page_container[0] )
    return;

var ERROR_BOX = page_container.find('#ERROR_BOX');
var create_form = page_container.find('#create_form');
var client_select = create_form.find('#client_select');
var idInput = create_form.find('#idInput');
var code_input = create_form.find('#code_input');
var nameInput = create_form.find('#nameInput');
var descInput = create_form.find('#descInput');
var quantityInput = create_form.find('#quantityInput');
var priceInput = create_form.find('#priceInput');
var wholesalePriceInput = create_form.find('#wholesalePriceInput');
var halfWholesalePriceInput = create_form.find('#halfWholesalePriceInput');
var buypriceInput = create_form.find('#buypriceInput');
var barcode_input = create_form.find('#barcode_input');
var paid_amount_input = create_form.find('#paid_amount_input');
var dept_amount_input = create_form.find('#dept_amount_input');
var totalAmountInput = create_form.find('#totalAmountInput');

var productsTable = create_form.find('#productsTable');
var addToListBTN = create_form.find('#addToListBTN');

// create_form
create_form.off('submit');
create_form.on('submit', async e =>
{
    e.preventDefault();

    SectionLoader(create_form);

    var order_amount_paid = paid_amount_input.val()
    var order_total_amount = totalAmountCalc()
    var order_dept_amount = dept_amount_input.val()

    var response = await ORDER_MODEL.direction_client_to_center_return_store({
        items: getList(),
        supplier_id: USER_CONFIG.administration.clinicId,
        supplier_name: USER_CONFIG.administration.clinicName,
        user_id: client_select.find(':selected').val(),
        order_receiver_name: client_select.find(':selected').text(),
        order_amount_paid: order_amount_paid,
        order_total_amount: order_total_amount,
        order_dept_amount: order_dept_amount,
    });
    SectionLoader(create_form, '');
    if ( response.code == 404 )
    {
        ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
        return;
    }
    ERROR_BOX.show(0).delay(7*1000).hide(0).find('#text').text(response.message);
    clearList();
    create_form[0].reset();
});
// productsTable
productsTable.off('click');
productsTable.on('click', e =>
{
    var target = $(e.target);
    if ( target.data('role') == 'REMOVE_FROM_LIST' )
    {
        target.closest('[data-role="ROW"]').remove();
        // calculate total amount
        totalAmountCalc()
    }
});
// addToListBTN
addToListBTN.off('click');
addToListBTN.on('click', e =>
{
    addToList();
});
// suggestion selected
$(document).off('suggestion-selected').on('suggestion-selected', e =>
{
    var detail = e.originalEvent.detail
    var suggestion = detail.suggestion
    
    idInput.val(suggestion.data.productId)
    nameInput.val( suggestion.name )
    descInput.val( suggestion.data.productDesc )
    buypriceInput.val( suggestion.data.productBuyPrice )
    priceInput.val( suggestion.data.productPrice )
    wholesalePriceInput.val( suggestion.data.productWholesalePrice )
    halfWholesalePriceInput.val( suggestion.data.productHalfWholesalePrice )
    // quantityInput.val( suggestion.data.productQuantity )
    barcode_input.val( suggestion.data.productBarcode )
})
// add to list
function addToList()
{

    var quantity = parseFloat(quantityInput.val())
    var order_item_final_amount = quantity * parseFloat(priceInput.val())

    var html = `<tr data-role="ROW" data-id="${idInput.val()}" data-code="${code_input.val()}" data-name="${nameInput.val()}" data-desc="${descInput.val()}" data-quantity="${quantityInput.val()}" data-price="${priceInput.val()}" data-dept-amount="${dept_amount_input.val()}" data-paid-amount="${paid_amount_input.val()}" data-final-amount="${order_item_final_amount}" data-barcode="${barcode_input.val()}">
                    <td>
                        <button class="btn-close" data-role="REMOVE_FROM_LIST"></button>
                    </td>
                    <td>${code_input.val()}</td>
                    <td>${nameInput.val()}</td>
                    <td>${quantityInput.val()}</td>
                </tr>PAG_SEP`;
                
    productsTable.find('tbody').append(html)
    // calculate total amount
    totalAmountCalc()
    code_input.val('')
    nameInput.val('')
}
// clear list
function clearList()
{
    productsTable.find('tbody').html('');
    // calculate total amount
    totalAmountCalc()
}
// get list
function getList()
{
    var list = [];
    var rows = productsTable.find('[data-role="ROW"]');
    for (let i = 0; i < rows.length; i++) 
    {
        const product = $(rows[i]);
        list.push({
            // supplier_id: supplierSelect.find(':selected').val(),
            // supplier_name: supplierSelect.find(':selected').text(),
            order_item_id: product.data('id'),
            order_item_quantity: product.data('quantity'),
            order_item_price: product.data('price'),
            order_item_final_amount: product.data('final-amount'),
        });
    }

    return list;
}
// calculate total amount
function totalAmountCalc()
{
    var items = getList()
    var total = 0

    for (let i = 0; i < items.length; i++) 
    {
        const item = items[i];
        total += item.order_item_final_amount
    }

    // display total amount
    totalAmountInput.val(total)

    return total
}

})

</script>